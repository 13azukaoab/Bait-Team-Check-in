rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================
    // Helper Functions
    // ===========================
    
    // ตรวจสอบว่าเป็น Request จาก App ของเรา (มี valid fields)
    function isValidCheckin() {
      let data = request.resource.data;
      return data.keys().hasAll(['team', 'customerName', 'contractNumber', 'branch', 'location', 'createdAt'])
        && data.team is string
        && data.team.size() <= 2
        && data.customerName is string
        && data.customerName.size() <= 200
        && data.contractNumber is string
        && data.contractNumber.size() <= 50
        && data.branch is string;
    }
    
    
    // ===========================
    // Check-ins Collection
    // ===========================
    match /checkins/{checkinId} {
      // อ่านได้ - ใช้งานใน Dashboard
      allow read: if true;
      
      // เขียนได้ - ต้องมี valid fields + rate limiting
      allow create: if isValidCheckin();
      
      // อัพเดท - เฉพาะ field ที่อนุญาต (visible, notes)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['visible', 'notes', 'updatedAt']);
      
      // ห้ามลบ
      allow delete: if false;
    }
    
    // ===========================
    // Scheduled Check-ins Collection
    // ===========================
    match /scheduled_checkins/{scheduleId} {
      // อ่านได้ - ทุกคน (Admin ใช้สำหรับ Dashboard)
      allow read: if true;
      
      // สร้างได้ - ต้องมี required fields
      allow create: if request.resource.data.keys().hasAll(['team', 'customerName', 'contractNumber', 'branch', 'scheduledDate', 'status'])
        && request.resource.data.team is string
        && request.resource.data.customerName is string
        && request.resource.data.contractNumber is string
        && request.resource.data.branch is string
        && request.resource.data.scheduledDate is string
        && (request.resource.data.status == 'pending' || request.resource.data.status == 'completed');
      
      // อัพเดท - เฉพาะ field ที่อนุญาต (status, completedAt)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['status', 'completedAt', 'completedCheckinId']);
      
      // ลบได้ - Admin ผ่าน Dashboard
      allow delete: if true;
    }

    // ===========================
    // Teams Collection (สำหรับข้อมูลทีม)
    // ===========================
    match /teams/{teamId} {
      allow read: if true;
      allow write: if false; // Admin only (ผ่าน Firebase Console)
    }
    
    // ===========================
    // Branches Collection (สำหรับข้อมูลสาขา)
    // ===========================
    match /branches/{branchId} {
      allow read: if true;
      allow write: if false; // Admin only
    }
    
    // ===========================
    // Customers Collection (สำหรับข้อมูลลูกค้า)
    // ===========================
    match /customers/{customerId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['name', 'contractNumber']);
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['name', 'phone', 'address', 'updatedAt']);
      allow delete: if false;
    }
    
    // ===========================
    // Stats Collection (สถิติ)
    // ===========================
    match /stats/{statId} {
      allow read: if true;
      allow write: if false; // Cloud Functions only
    }
    
  }
}
