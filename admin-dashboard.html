<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bait Check-In | Admin Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="image/favicon.svg">
    <link rel="apple-touch-icon" href="image/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCDvOxdpMIQoadHlod90EtQgpEU4tDcHUY",
            authDomain: "bait-check-in-webapp.firebaseapp.com",
            projectId: "bait-check-in-webapp",
            storageBucket: "bait-check-in-webapp.firebasestorage.app",
            messagingSenderId: "850336159440",
            appId: "1:850336159440:web:c104204bd3f2d18b5b70d5",
            measurementId: "G-V52G8M5H6Z"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
    </script>
    
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --primary-light: #7dd3fc;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-bg: #0f172a;
            --sidebar-hover: #1e293b;
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
        }

        /* Dark mode removed per requirements */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Collapsible Animation */
        .sidebar {
            width: 72px;
            background: var(--sidebar-bg);
            color: white;
            padding: 16px 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .sidebar:hover {
            width: 260px;
        }

        .sidebar:hover .logo-text,
        .sidebar:hover .nav-text {
            opacity: 1;
            transform: translateX(0);
        }

        .sidebar:hover .logo {
            padding: 0 24px 20px;
        }

        .sidebar:hover .nav-item {
            padding: 14px 24px;
        }

        .logo {
            padding: 0 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 16px;
            transition: padding 0.3s ease;
            white-space: nowrap;
        }

        .logo h1 {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s ease 0.1s;
        }

        .logo h1 i {
            color: var(--primary);
        }

        /* Speed Motion Logo */
        .app-logo {
            width: 40px;
            height: 34px;
            min-width: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transform: skew(-10deg);
            background: var(--primary);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
        }
        .app-logo i {
            color: white !important;
            font-size: 20px;
            transform: skew(10deg);
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            white-space: nowrap;
            position: relative;
        }

        .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s ease 0.1s;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: white;
        }

        .nav-item.active {
            background: var(--sidebar-hover);
            color: white;
            border-left-color: var(--primary);
        }

        .nav-item i {
            width: 24px;
            min-width: 24px;
            text-align: center;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .nav-item:hover i {
            transform: scale(1.1);
        }

        /* Tooltip for collapsed sidebar */
        .nav-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 72px;
            background: var(--sidebar-bg);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .sidebar:not(:hover) .nav-item:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Team Badges */
        .team-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .team-badge.team-a { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .team-badge.team-b { background: linear-gradient(135deg, #10b981, #059669); }
        .team-badge.team-c { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .team-badge.team-d { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .team-badge.team-e { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .team-badge.team-f { background: linear-gradient(135deg, #ec4899, #db2777); }
        .team-badge.team-g { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .team-badge.team-h { background: linear-gradient(135deg, #84cc16, #65a30d); }
        .team-badge.team-i { background: linear-gradient(135deg, #f97316, #ea580c); }
        .team-badge.team-j { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .team-badge.team-k { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        .team-badge.team-l { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .team-badge.team-m { background: linear-gradient(135deg, #f43f5e, #e11d48); }
        .team-badge.team-n { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .team-badge.team-o { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .team-badge.team-z { background: linear-gradient(135deg, #1e1e1e, #3d3d3d); }

        .team-badge-sm {
            width: 24px;
            height: 24px;
            font-size: 0.7rem;
            border-radius: 6px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 72px;
            padding: 24px;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Sidebar Expand Indicator */
        .sidebar-expand-hint {
            position: fixed;
            left: 72px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            background: linear-gradient(to right, rgba(30, 41, 59, 0.3), transparent);
            border-radius: 0 8px 8px 0;
            z-index: 99;
            pointer-events: none;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover ~ .sidebar-expand-hint,
        .sidebar-expand-hint:hover {
            opacity: 0;
        }

        /* Top Header */
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: var(--bg-card);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .search-box {
            position: relative;
            width: 320px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: 'Prompt', sans-serif;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-toggle {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .notification-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: none;
            background: var(--bg-main);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: var(--primary);
            color: white;
        }

        .notification-btn .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--danger);
            border-radius: 50%;
            font-size: 0.7rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-btn .badge.hidden {
            display: none;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 360px;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .notification-dropdown.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .notification-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .notification-header .mark-all {
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            background: none;
            border: none;
            font-family: 'Prompt', sans-serif;
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 14px 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-main);
        }

        .notification-item.unread {
            background: rgba(14, 165, 233, 0.05);
        }

        .notification-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-item .icon.checkin {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .notification-item .icon.warning {
            background: rgba(249, 115, 22, 0.1);
            color: var(--warning);
        }

        .notification-item .icon.info {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary);
        }

        .notification-item .content {
            flex: 1;
            min-width: 0;
        }

        .notification-item .content .title {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .notification-item .content .desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-item .content .time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .notification-empty i {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .notification-wrapper {
            position: relative;
        }

        /* Stat Cards */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary);
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-icon.orange {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-icon.purple {
            background: rgba(168, 85, 247, 0.1);
            color: #a855f7;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-info p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .stat-trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }

        .stat-trend.up {
            color: var(--success);
        }

        .stat-trend.down {
            color: var(--danger);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 24px;
        }

        /* Map Section */
        .map-section {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .map-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            border-radius: 0;
            width: 100vw;
            height: 100vh;
        }
        
        .map-section.fullscreen .map-container {
            height: calc(100vh - 80px);
        }
        
        .map-section.fullscreen #map {
            height: 100%;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header h2 i {
            color: var(--primary);
        }

        .header-actions-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: 'Prompt', sans-serif;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        #map {
            height: 450px;
            width: 100%;
        }

        /* Leaflet zoom controls - ให้อยู่ต่ำกว่า sidebar */
        .leaflet-control-container .leaflet-top,
        .leaflet-control-container .leaflet-left {
            z-index: 500 !important;
        }

        .leaflet-control-zoom {
            z-index: 500 !important;
        }

        /* Checkins List */
        .checkins-section {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            max-height: 550px;
        }

        .checkins-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .checkin-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: var(--bg-main);
            transition: all 0.3s ease;
        }

        .checkin-item:hover {
            background: rgba(14, 165, 233, 0.05);
        }

        .checkin-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .checkin-info {
            flex: 1;
        }

        .checkin-info .name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .checkin-info .location {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkin-info .time {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        .checkin-info .time .actual-time {
            color: var(--primary);
            font-weight: 500;
        }

        .checkin-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .checkin-status.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .checkin-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .checkin-status.inactive {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-secondary);
        }

        /* Checkin Actions (Toggle + Navigate) */
        .checkin-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--primary), var(--accent));
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Toggle switch in table - ensure proper display */
        .data-table .toggle-switch {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .data-table .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--primary), var(--accent)) !important;
        }

        /* Table View */
        .table-section {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-top: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 16px 20px;
            text-align: left;
        }

        .data-table th {
            background: var(--bg-main);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table th:first-child {
            border-radius: 12px 0 0 0;
        }

        .data-table th:last-child {
            border-radius: 0 12px 0 0;
        }

        /* Sortable Table Headers */
        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .data-table th.sortable:hover {
            background: rgba(14, 165, 233, 0.1);
        }

        .data-table th .sort-icon {
            margin-left: 6px;
            color: var(--text-tertiary);
            font-size: 0.75rem;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .data-table th.sortable:hover .sort-icon {
            color: var(--primary);
        }

        .data-table th.sort-asc .sort-icon,
        .data-table th.sort-desc .sort-icon {
            color: var(--primary);
        }

        .data-table td {
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: rgba(14, 165, 233, 0.02);
        }

        /* Scrollable Table Container */
        .table-scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 12px;
        }

        .table-scroll-container .data-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .table-scroll-container .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-scroll-container .data-table thead th {
            background: var(--bg-main);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Custom Scrollbar */
        .table-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-scroll-container::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 4px;
        }

        .table-scroll-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), #0284c7);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #0ea5e9, #0369a1);
        }

        /* Firefox Scrollbar */
        .table-scroll-container {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-main);
        }

        .visibility-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Filter Panel */
        .filter-panel {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: none;
        }

        .filter-panel.active {
            display: block;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: 'Prompt', sans-serif;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Distance Panel */
        .distance-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 280px;
            display: none;
        }

        .distance-panel.active {
            display: block;
        }

        .distance-panel h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .distance-panel h4 i {
            color: var(--primary);
        }

        .distance-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .distance-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
        }

        .distance-value span {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .btn-measure {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
        }

        .btn-measure.active {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-measure:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-radius {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }

        .btn-radius.active {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-radius:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }

        /* Radius Panel - Compact Design like Distance Panel */
        .radius-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 200px;
            display: none;
        }
        
        .radius-panel .radius-presets {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            flex-wrap: wrap;
        }
        
        .radius-panel .preset-btn {
            padding: 6px 12px;
            border: 2px solid #0ea5e9;
            background: white;
            color: #0ea5e9;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .radius-panel .preset-btn:hover,
        .radius-panel .preset-btn.active {
            background: #0ea5e9;
            color: white;
        }
        
        .radius-panel .radius-slider-group {
            margin: 16px 0;
        }
        
        .radius-panel .radius-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin: 8px 0;
        }
        
        .radius-panel .radius-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(14, 165, 233, 0.4);
        }
        
        .radius-panel .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .radius-panel .action-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .radius-panel .btn-apply {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }
        
        .radius-panel .btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }
        
        .radius-panel .btn-clear {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .radius-panel .btn-clear:hover {
            background: #fecaca;
        }
        
        /* Resize Handle for Radius Circle */
        .resize-handle {
            width: 16px;
            height: 16px;
            background: white;
            border: 3px solid #0ea5e9;
            border-radius: 50%;
            cursor: nwse-resize;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1001;
        }
        
        .resize-handle:hover {
            background: #0ea5e9;
            transform: scale(1.2);
        }
        
        /* Active circle indicator */
        .radius-circle-active {
            stroke: #0ea5e9 !important;
            stroke-width: 3px !important;
            stroke-dasharray: none !important;
        }

        /* HQ Button */
        .btn-hq {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-hq:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }
        
        /* HQ Marker */
        .hq-marker {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: hqPulse 2s infinite;
        }
        
        @keyframes hqPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(245, 158, 11, 0.7); }
        }

        .radius-panel.active {
            display: block;
        }

        .radius-panel h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radius-panel h4 i {
            color: #0ea5e9;
        }

        .radius-input-group {
            margin-bottom: 12px;
        }

        .radius-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .radius-input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .radius-input-group input:focus {
            outline: none;
            border-color: #0ea5e9;
        }

        .radius-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #0ea5e9;
        }

        .radius-value span {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .radius-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Map container for distance panel positioning */
        .map-container {
            position: relative;
        }

        /* Photo Gallery Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2 i {
            color: var(--primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--bg-main);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .gallery-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 4/3;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .gallery-item:hover {
            transform: scale(1.02);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .gallery-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
        }

        .gallery-item .gallery-info .name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .gallery-item .gallery-info .meta {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Gallery Album */
        .gallery-album {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }

        .gallery-album:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .gallery-album .album-cover {
            position: relative;
            aspect-ratio: 4/3;
            overflow: hidden;
        }

        .gallery-album .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .gallery-album:hover .album-cover img {
            transform: scale(1.05);
        }

        .gallery-album .photo-count {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .gallery-album .album-info {
            padding: 14px;
        }

        .gallery-album .album-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .gallery-album .album-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .gallery-album .album-contract {
            font-size: 0.75rem;
            color: var(--primary);
            font-family: monospace;
        }

        /* Image Viewer */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 60px 80px;
            box-sizing: border-box;
        }

        .image-viewer.active {
            display: flex;
        }

        .image-viewer img {
            max-width: 100%;
            max-height: calc(100% - 120px);
            border-radius: 12px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            object-fit: contain;
        }

        .image-viewer .viewer-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            color: white;
            text-align: center;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
        }

        .image-viewer .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .image-viewer .viewer-close:hover {
            background: var(--danger);
        }

        .image-viewer .viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-viewer .viewer-nav:hover {
            background: rgba(255,255,255,0.3);
        }

        .image-viewer .viewer-nav.prev {
            left: 20px;
        }

        .image-viewer .viewer-nav.next {
            right: 20px;
        }

        .image-viewer .viewer-counter {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* Charts Container */
        .chart-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-header h3 i {
            color: var(--primary);
        }

        .chart-wrapper {
            height: 250px;
            position: relative;
        }

        /* Bar Chart (CSS-based) */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 200px;
            padding: 20px 0;
            border-bottom: 2px solid var(--border);
        }

        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .bar {
            width: 40px;
            border-radius: 8px 8px 0 0;
            background: linear-gradient(to top, var(--primary), var(--accent));
            transition: height 0.5s ease;
            position: relative;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .bar-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Donut Chart (CSS-based) */
        .donut-chart {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .donut-center .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .donut-center .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Real-time Indicator */
        .realtime-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--success);
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Export Dropdown */
        .export-dropdown {
            position: relative;
        }

        .export-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .export-menu.active {
            display: block;
        }

        .export-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'Prompt', sans-serif;
            font-size: 0.9rem;
        }

        .export-menu-item:hover {
            background: var(--bg-main);
        }

        .export-menu-item i {
            width: 20px;
            color: var(--text-secondary);
        }

        .export-menu-item.excel i { color: #217346; }
        .export-menu-item.csv i { color: #0ea5e9; }
        .export-menu-item.pdf i { color: #ef4444; }

        /* Team Filter Dropdown */
        .team-filter-dropdown {
            position: relative;
        }

        .team-filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 320px;
            z-index: 2000;
            display: none;
            overflow: visible;
        }

        .team-filter-menu.active {
            display: block;
        }

        .team-filter-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn-mini {
            padding: 4px 10px;
            font-size: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-main);
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
            transition: all 0.2s ease;
        }

        .btn-mini:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .team-filter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 16px;
        }

        .team-filter-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-main);
        }

        .team-filter-item:hover {
            background: rgba(14, 165, 233, 0.1);
        }

        .team-filter-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .team-filter-item input[type="checkbox"]:not(:checked) + .team-badge {
            opacity: 0.4;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1><span class="app-logo"><i class="fas fa-paper-plane"></i></span> <span class="logo-text">Bait Check-In</span></h1>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-page="dashboard" data-tooltip="Dashboard" onclick="showPage('dashboard')">
                    <i class="fas fa-chart-pie"></i>
                    <span class="nav-text">Dashboard</span>
                </div>
                <div class="nav-item" data-page="mapview" data-tooltip="Map View" onclick="showPage('mapview')">
                    <i class="fas fa-map-location-dot"></i>
                    <span class="nav-text">Map View</span>
                </div>
                <div class="nav-item" data-page="checkins" data-tooltip="Check-ins List" onclick="showPage('checkins')">
                    <i class="fas fa-list-check"></i>
                    <span class="nav-text">Check-ins List</span>
                </div>
                <div class="nav-item" data-page="customers" data-tooltip="Customers" onclick="showPage('customers')">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Customers</span>
                </div>
                <div class="nav-item" data-page="reports" data-tooltip="Reports" onclick="showPage('reports')">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-text">Reports</span>
                </div>
                <div class="nav-item" data-page="gallery" data-tooltip="Photo Gallery" onclick="showPage('gallery')">
                    <i class="fas fa-images"></i>
                    <span class="nav-text">Photo Gallery</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <div class="top-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="ค้นหาลูกค้า, สถานที่..." id="globalSearch" onkeyup="handleGlobalSearch(this.value)">
                </div>
                <div class="header-actions">
                    <!-- Real-time Indicator -->
                    <div class="realtime-badge" id="realtimeBadge">
                        <span class="realtime-dot"></span>
                        <span>Live</span>
                    </div>
                    <div class="notification-wrapper">
                        <button class="notification-btn" id="notificationBtn" onclick="toggleNotificationDropdown(event)">
                            <i class="fas fa-bell"></i>
                            <span class="badge hidden" id="notificationCount">0</span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h4><i class="fas fa-bell" style="margin-right: 8px;"></i>การแจ้งเตือน</h4>
                                <button class="mark-all" onclick="clearAllNotifications()">ล้างทั้งหมด</button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>ยังไม่มีการแจ้งเตือน</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div class="page-content" id="page-dashboard">
            <!-- Stat Cards -->
            <div class="stat-cards">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-location-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="statCheckinsToday">0</h3>
                        <p>Check-ins วันนี้</p>
                        <div class="stat-trend" id="statCheckinsTrend" style="display: none;">
                            <i class="fas fa-arrow-up"></i> <span></span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-map-pin"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="statActiveLocations">0</h3>
                        <p>Active Locations</p>
                        <div class="stat-trend" id="statLocationsTrend" style="display: none;">
                            <i class="fas fa-arrow-up"></i> <span></span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="statTotalCustomers">0</h3>
                        <p>Total Customers</p>
                        <div class="stat-trend" id="statCustomersTrend" style="display: none;">
                            <i class="fas fa-arrow-up"></i> <span></span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-chart-simple"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="statSuccessRate">0%</h3>
                        <p>อัตราความสำเร็จ</p>
                        <div class="stat-trend" id="statSuccessTrend" style="display: none;">
                            <i class="fas fa-arrow-up"></i> <span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Filter Panel -->
                <div class="filter-panel" id="filterPanel">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label><i class="fas fa-users"></i> ทีม</label>
                            <select id="filterTeam">
                                <option value="all">ทั้งหมด</option>
                                <option value="A">Team A</option>
                                <option value="B">Team B</option>
                                <option value="C">Team C</option>
                                <option value="D">Team D</option>
                                <option value="E">Team E</option>
                                <option value="F">Team F</option>
                                <option value="G">Team G</option>
                                <option value="H">Team H</option>
                                <option value="I">Team I</option>
                                <option value="J">Team J</option>
                                <option value="K">Team K</option>
                                <option value="L">Team L</option>
                                <option value="M">Team M</option>
                                <option value="N">Team N</option>
                                <option value="O">Team O</option>
                                <option value="Z">Team Z</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-map-marker-alt"></i> เขต</label>
                            <select id="filterZone">
                                <option value="all">ทั้งหมด</option>
                                <option value="เขต 1">เขต 1</option>
                                <option value="เขต 2">เขต 2</option>
                                <option value="เขต 3">เขต 3</option>
                                <option value="เขต 4">เขต 4</option>
                                <option value="เขต 5">เขต 5</option>
                                <option value="เขต 6">เขต 6</option>
                                <option value="เขต 7">เขต 7</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-building"></i> สาขา</label>
                            <select id="filterBranch">
                                <option value="all">ทั้งหมด</option>
                                <optgroup label="เขต 1">
                                    <option>พุทธมณฑล</option>
                                    <option>นครปฐม</option>
                                    <option>หัวหิน</option>
                                    <option>พระราม 2</option>
                                </optgroup>
                                <optgroup label="เขต 2">
                                    <option>สาทร</option>
                                    <option>ปทุมวัน</option>
                                    <option>พระราม 4</option>
                                    <option>นนทบุรี</option>
                                </optgroup>
                                <optgroup label="เขต 3">
                                    <option>ปทุมธานี</option>
                                    <option>รามอินทรา</option>
                                    <option>อยุธยา</option>
                                </optgroup>
                                <optgroup label="เขต 4">
                                    <option>ลาดพร้าว</option>
                                    <option>พัฒนาการ</option>
                                    <option>สุวินทวงศ์</option>
                                    <option>ประชาชื่น</option>
                                </optgroup>
                                <optgroup label="เขต 5">
                                    <option>ปราจีนบุรี</option>
                                    <option>สมุทรปราการ</option>
                                    <option>พัทยา</option>
                                    <option>ระยอง</option>
                                </optgroup>
                                <optgroup label="เขต 6">
                                    <option>สุขุมวิท</option>
                                    <option>ปากน้ำ</option>
                                    <option>ชลบุรี</option>
                                </optgroup>
                                <optgroup label="เขต 7">
                                    <option>ปากช่อง</option>
                                    <option>สระบุรี</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-calendar"></i> วันที่</label>
                            <input type="date" id="filterDate" value="2026-01-22">
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" onclick="applyFilters()" style="width: 100%;">
                                <i class="fas fa-search"></i> ค้นหา
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="map-section">
                    <div class="section-header">
                        <h2><i class="fas fa-map"></i> Location Map</h2>
                        <div class="header-actions-group">
                            <button class="btn btn-hq" onclick="goToHQ()" title="ไปสำนักงานใหญ่">
                                <i class="fas fa-building"></i> HQ
                            </button>
                            <button class="btn btn-navigate" onclick="navigateToSelected()" title="นำทางไปยังจุดที่เลือก" id="navigateBtn">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                            <button class="btn btn-outline" onclick="toggleFilter()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button class="btn btn-measure" id="measureBtn" onclick="toggleMeasure()">
                                <i class="fas fa-ruler"></i> วัดระยะ
                            </button>
                            <button class="btn btn-radius" id="radiusBtn" onclick="toggleRadius()">
                                <i class="fas fa-circle"></i> วัดรัศมี
                            </button>
                            <button class="btn btn-primary" onclick="toggleMapFullScreen()" id="fullScreenBtn">
                                <i class="fas fa-expand"></i> Full Screen
                            </button>
                        </div>
                    </div>
                    <div class="map-container">
                        <div id="map"></div>
                        <!-- Distance Panel -->
                        <div class="distance-panel" id="distancePanel">
                            <h4><i class="fas fa-ruler"></i> วัดระยะทาง</h4>
                            <div class="distance-info" id="distanceInfo">คลิกจุดแรกบนแผนที่...</div>
                            <div class="distance-value" id="distanceValue">-- <span>กม.</span></div>
                        </div>
                        
                        <!-- Radius Panel - Drag to Draw Design -->
                        <div class="radius-panel" id="radiusPanel">
                            <h4><i class="fas fa-circle"></i> วาดวงกลมรัศมี</h4>
                            <div class="radius-info" id="radiusInfo">
                                <i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม
                            </div>
                            <div class="radius-value" id="radiusValue">0 <span>เมตร</span></div>
                            <div class="action-buttons">
                                <button class="btn-clear" onclick="clearRadius()"><i class="fas fa-trash"></i> ล้าง</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Check-ins -->
                <div class="checkins-section">
                    <div class="section-header">
                        <h2><i class="fas fa-clock-rotate-left"></i> Recent Check-ins</h2>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <!-- Team Filter for Map -->
                            <div class="team-filter-dropdown">
                                <button class="btn btn-outline" style="padding: 8px 14px;" onclick="toggleTeamFilterMenu()">
                                    <i class="fas fa-users"></i> ทีม <i class="fas fa-chevron-down" style="font-size: 0.7rem; margin-left: 4px;"></i>
                                </button>
                                <div class="team-filter-menu" id="teamFilterMenu">
                                    <div class="team-filter-header">
                                        <span style="font-weight: 600;">เลือกทีมที่จะแสดง</span>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="selectAllTeams(true)" class="btn-mini">เลือกทั้งหมด</button>
                                            <button onclick="selectAllTeams(false)" class="btn-mini">ยกเลิกทั้งหมด</button>
                                        </div>
                                    </div>
                                    <div class="team-filter-grid">
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('A', this.checked)"><span class="team-badge team-badge-sm team-a">A</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('B', this.checked)"><span class="team-badge team-badge-sm team-b">B</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('C', this.checked)"><span class="team-badge team-badge-sm team-c">C</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('D', this.checked)"><span class="team-badge team-badge-sm team-d">D</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('E', this.checked)"><span class="team-badge team-badge-sm team-e">E</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('F', this.checked)"><span class="team-badge team-badge-sm team-f">F</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('G', this.checked)"><span class="team-badge team-badge-sm team-g">G</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('H', this.checked)"><span class="team-badge team-badge-sm team-h">H</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('I', this.checked)"><span class="team-badge team-badge-sm team-i">I</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('J', this.checked)"><span class="team-badge team-badge-sm team-j">J</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('K', this.checked)"><span class="team-badge team-badge-sm team-k">K</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('L', this.checked)"><span class="team-badge team-badge-sm team-l">L</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('M', this.checked)"><span class="team-badge team-badge-sm team-m">M</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('N', this.checked)"><span class="team-badge team-badge-sm team-n">N</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('O', this.checked)"><span class="team-badge team-badge-sm team-o">O</span></label>
                                        <label class="team-filter-item"><input type="checkbox" checked onchange="filterByTeam('Z', this.checked)"><span class="team-badge team-badge-sm team-z">Z</span></label>
                                    </div>
                                </div>
                            </div>
                            <!-- Export Dropdown -->
                            <div class="export-dropdown">
                                <button class="btn btn-outline" style="padding: 8px 14px;" onclick="toggleExportMenu('recent')">
                                    <i class="fas fa-download"></i> Export <i class="fas fa-chevron-down" style="font-size: 0.7rem; margin-left: 4px;"></i>
                                </button>
                                <div class="export-menu" id="exportMenuRecent">
                                    <button class="export-menu-item excel" onclick="exportToExcel('recent-checkins')">
                                        <i class="fas fa-file-excel"></i> Export Excel
                                    </button>
                                    <button class="export-menu-item csv" onclick="exportToCSV('recent-checkins')">
                                        <i class="fas fa-file-csv"></i> Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="checkins-list" id="recentCheckinsListContainer">
                        <!-- Recent Check-ins จะถูก load จาก Firestore -->
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p style="margin-top: 16px;">กำลังโหลดข้อมูล...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Full Data Table -->
            <div class="table-section">
                <div class="section-header">
                    <h2><i class="fas fa-table"></i> All Check-ins Data</h2>
                    <div class="header-actions-group">
                        <button class="btn btn-outline" onclick="toggleFilter()">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <div class="export-dropdown">
                            <button class="btn btn-primary" onclick="toggleExportMenu('full')">
                                <i class="fas fa-file-export"></i> Export <i class="fas fa-chevron-down" style="font-size: 0.7rem; margin-left: 4px;"></i>
                            </button>
                            <div class="export-menu" id="exportMenuFull">
                                <button class="export-menu-item excel" onclick="exportToExcel('full-data')">
                                    <i class="fas fa-file-excel"></i> Export Excel (.xlsx)
                                </button>
                                <button class="export-menu-item csv" onclick="exportToCSV('full-data')">
                                    <i class="fas fa-file-csv"></i> Export CSV
                                </button>
                                <button class="export-menu-item pdf" onclick="exportToPDF()">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ทีม</th>
                            <th>ลูกค้า</th>
                            <th>สถานที่</th>
                            <th>พิกัด</th>
                            <th>เวลา</th>
                            <th>สถานะ</th>
                            <th>แสดงบนแผนที่</th>
                        </tr>
                    </thead>
                    <tbody id="mainCheckinsTableBody">
                        <!-- Data loaded from Firestore -->
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูลจาก Firebase...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div><!-- End Dashboard Page -->

            <!-- Map View Page -->
            <div class="page-content" id="page-mapview" style="display: none;">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-map-location-dot" style="color: var(--primary);"></i> Map View
                </h2>
                <div class="map-section" style="height: calc(100vh - 200px); position: relative;">
                    <div class="section-header">
                        <div class="header-actions-group">
                            <!-- Team Filter Dropdown with Checkboxes -->
                            <div class="team-filter-dropdown" id="mapViewTeamFilterDropdown">
                                <button class="btn btn-outline team-filter-btn" onclick="toggleMapViewTeamFilter()">
                                    <i class="fas fa-users"></i> ทีม <i class="fas fa-chevron-down" style="margin-left: 8px; font-size: 0.8rem;"></i>
                                </button>
                                <div class="team-filter-menu" id="mapViewTeamFilterMenu">
                                    <div class="team-filter-header">
                                        <span>เลือกทีมที่จะแสดง</span>
                                        <div>
                                            <button class="btn-link" onclick="mapViewSelectAllTeams()">เลือกทั้งหมด</button>
                                            <button class="btn-link" onclick="mapViewDeselectAllTeams()">ยกเลิกทั้งหมด</button>
                                        </div>
                                    </div>
                                    <div class="team-filter-grid">
                                        <label class="team-checkbox"><input type="checkbox" value="A" checked onchange="filterMapViewByTeam()"><span class="team-badge team-a">A</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="B" checked onchange="filterMapViewByTeam()"><span class="team-badge team-b">B</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="C" checked onchange="filterMapViewByTeam()"><span class="team-badge team-c">C</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="D" checked onchange="filterMapViewByTeam()"><span class="team-badge team-d">D</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="E" checked onchange="filterMapViewByTeam()"><span class="team-badge team-e">E</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="F" checked onchange="filterMapViewByTeam()"><span class="team-badge team-f">F</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="G" checked onchange="filterMapViewByTeam()"><span class="team-badge team-g">G</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="H" checked onchange="filterMapViewByTeam()"><span class="team-badge team-h">H</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="I" checked onchange="filterMapViewByTeam()"><span class="team-badge team-i">I</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="J" checked onchange="filterMapViewByTeam()"><span class="team-badge team-j">J</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="K" checked onchange="filterMapViewByTeam()"><span class="team-badge team-k">K</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="L" checked onchange="filterMapViewByTeam()"><span class="team-badge team-l">L</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="M" checked onchange="filterMapViewByTeam()"><span class="team-badge team-m">M</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="N" checked onchange="filterMapViewByTeam()"><span class="team-badge team-n">N</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="O" checked onchange="filterMapViewByTeam()"><span class="team-badge team-o">O</span></label>
                                        <label class="team-checkbox"><input type="checkbox" value="Z" checked onchange="filterMapViewByTeam()"><span class="team-badge team-z">Z</span></label>
                                    </div>
                                </div>
                            </div>
                            <select style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: 'Prompt', sans-serif;">
                                <option>วันนี้</option>
                                <option>เมื่อวาน</option>
                                <option>7 วันที่แล้ว</option>
                                <option>30 วันที่แล้ว</option>
                            </select>
                            <button class="btn btn-primary" onclick="filterMapView()"><i class="fas fa-search"></i> ค้นหา</button>
                        </div>
                        <div class="header-actions-group">
                            <button class="btn btn-hq" onclick="goToHQMapView()">
                                <i class="fas fa-building"></i> HQ
                            </button>
                             <button class="btn btn-measure" id="measureBtnFull" onclick="toggleMeasureFull()">
                                <i class="fas fa-ruler"></i> วัดระยะ
                            </button>
                            <button class="btn btn-radius" id="radiusBtnFull" onclick="toggleRadiusFull()">
                                <i class="fas fa-circle"></i> วัดรัศมี
                            </button>
                        </div>
                    </div>
                    <!-- Full Screen Map Container -->
                    <div id="map-view" style="height: calc(100% - 81px); width: 100%; z-index: 1;"></div>
                    
                    <!-- Distance Panel for Map View -->
                    <div class="distance-panel" id="distancePanelFull">
                        <h4><i class="fas fa-ruler"></i> วัดระยะทาง</h4>
                        <div class="distance-info" id="distanceInfoFull">คลิกจุดแรกบนแผนที่...</div>
                        <div class="distance-value" id="distanceValueFull">-- <span>กม.</span></div>
                    </div>
                    
                    <!-- Radius Panel for Map View -->
                    <div class="radius-panel" id="radiusPanelFull">
                        <h4><i class="fas fa-circle"></i> วาดวงกลมรัศมี</h4>
                        <div class="radius-info" id="radiusInfoFull">
                            <i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม
                        </div>
                        <div class="radius-value" id="radiusValueFull">0 <span>เมตร</span></div>
                        <div class="action-buttons">
                            <button class="btn-clear" onclick="clearRadiusFull()"><i class="fas fa-trash"></i> ล้าง</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Check-ins List Page -->
            <div class="page-content" id="page-checkins" style="display: none;">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-list-check" style="color: var(--primary);"></i> Check-ins List
                </h2>
                <div class="table-section">
                    <div class="section-header">
                        <div style="display: flex; gap: 10px;">
                            <input type="text" placeholder="ค้นหาลูกค้า, เลขสัญญา..." style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; width: 300px; font-family: 'Prompt', sans-serif;">
                            <select style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: 'Prompt', sans-serif;">
                                <option>ทุกทีม</option>
                                <option>Team A</option>
                                <option>Team B</option>
                            </select>
                            <select style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: 'Prompt', sans-serif;">
                                <option>ทุกสถานะ</option>
                                <option>Active</option>
                                <option>Pending</option>
                            </select>
                        </div>
                        <div class="header-actions-group">
                            <button class="btn btn-outline"><i class="fas fa-filter"></i> Filter</button>
                            <button class="btn btn-primary"><i class="fas fa-file-export"></i> Export</button>
                        </div>
                    </div>
                    <div class="table-scroll-container">
                    <table class="data-table" id="checkins-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="0" onclick="sortTable('checkins-table', 0)">
                                    ทีม <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="1" onclick="sortTable('checkins-table', 1)">
                                    ลูกค้า <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="2" onclick="sortTable('checkins-table', 2)">
                                    เลขสัญญา <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="3" onclick="sortTable('checkins-table', 3)">
                                    สาขา <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="4" onclick="sortTable('checkins-table', 4)">
                                    เวลา <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="5" onclick="sortTable('checkins-table', 5)">
                                    สถานะ <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th>ภาพ</th>
                            </tr>
                        </thead>
                        <tbody id="checkinsTableBody">
                            <!-- Data loaded from Firestore -->
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                    <div style="padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border);">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;" id="checkinsTableInfo">แสดง 0 รายการ</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-outline" style="padding: 8px 12px;"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn btn-primary" style="padding: 8px 12px;">1</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;">2</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;">3</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Page -->
            <div class="page-content" id="page-customers" style="display: none;">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-users" style="color: var(--primary);"></i> Customers
                </h2>
                <div class="stat-cards" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <h3 id="customerTotal">0</h3>
                            <p>ลูกค้าทั้งหมด</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-user-check"></i></div>
                        <div class="stat-info">
                            <h3 id="customerActive">0</h3>
                            <p>ลูกค้า Active</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-user-plus"></i></div>
                        <div class="stat-info">
                            <h3 id="customerNewMonth">0</h3>
                            <p>ลูกค้าใหม่เดือนนี้</p>
                        </div>
                    </div>
                </div>
                <div class="table-section">
                    <div class="section-header">
                        <input type="text" placeholder="ค้นหาลูกค้า..." style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; width: 300px; font-family: 'Prompt', sans-serif;">
                        <button class="btn btn-primary"><i class="fas fa-plus"></i> เพิ่มลูกค้า</button>
                    </div>
                    <div class="table-scroll-container">
                    <table class="data-table" id="customers-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="0" onclick="sortTable('customers-table', 0)">
                                    ลูกค้า <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="1" onclick="sortTable('customers-table', 1)">
                                    เลขสัญญา <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="2" onclick="sortTable('customers-table', 2)">
                                    สาขา <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="3" onclick="sortTable('customers-table', 3)">
                                    ติดตามล่าสุด <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="4" onclick="sortTable('customers-table', 4)">
                                    Check-ins <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="5" onclick="sortTable('customers-table', 5)">
                                    สถานะ <i class="fas fa-sort sort-icon"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <i class="fas fa-users" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 10px;"></i>
                                    ยังไม่มีข้อมูลลูกค้า<br>
                                    <small>ข้อมูลจะแสดงเมื่อมีการ Check-in</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                    <div style="padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border);">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;" id="customersTableInfo">แสดง 0 รายการ</span>
                        <div style="display: flex; gap: 8px;">
                            <!-- Pagination จะแสดงเมื่อมีข้อมูล -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div class="page-content" id="page-reports" style="display: none;">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-chart-line" style="color: var(--primary);"></i> Reports
                </h2>
                <div class="stat-cards" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-calendar-check"></i></div>
                        <div class="stat-info">
                            <h3 id="reportCheckinsMonth">0</h3>
                            <p>Check-ins เดือนนี้</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-percentage"></i></div>
                        <div class="stat-info">
                            <h3 id="reportSuccessRate">0%</h3>
                            <p>อัตราความสำเร็จ</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
                        <div class="stat-info">
                            <h3 id="reportAvgTime">- นาที</h3>
                            <p>เวลาเฉลี่ยต่อสาย</p>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="content-grid" style="grid-template-columns: 2fr 1fr; margin-bottom: 24px;">
                    <!-- Bar Chart - Check-ins per Day -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Check-ins รายวัน (7 วันล่าสุด)</h3>
                            <select style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px; font-family: 'Prompt', sans-serif;">
                                <option>7 วัน</option>
                                <option>14 วัน</option>
                                <option>30 วัน</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <div class="bar-chart" id="barChart">
                                <!-- กราฟจะแสดงข้อมูลจริงเมื่อมีข้อมูลใน Firestore -->
                                <div style="text-align: center; padding: 60px; color: var(--text-secondary); grid-column: 1/-1;">
                                    <i class="fas fa-chart-bar fa-2x" style="opacity: 0.5;"></i>
                                    <p style="margin-top: 16px;">ยังไม่มีข้อมูลสำหรับสร้างกราฟ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Donut Chart - Status Distribution -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-pie"></i> สถานะ Check-in</h3>
                        </div>
                        <div class="chart-wrapper" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div class="donut-chart" id="donutChart" style="background: conic-gradient(#e5e7eb 0deg 360deg);">
                                <div class="donut-center">
                                    <span class="value" id="donutValue">0</span>
                                    <span class="label">รายการ</span>
                                </div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #10b981;"></span>
                                    <span id="legendSuccess">สำเร็จ (0%)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #f59e0b;"></span>
                                    <span id="legendPending">รอดำเนินการ (0%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Performance -->
                <div class="chart-container" style="margin-bottom: 24px;">
                    <div class="chart-header">
                        <h3><i class="fas fa-users"></i> Performance รายทีม</h3>
                    </div>
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-users fa-2x" style="opacity: 0.5;"></i>
                        <p style="margin-top: 16px;">ยังไม่มีข้อมูลสำหรับแสดง Performance</p>
                        <p style="font-size: 0.85rem;">ข้อมูลจะแสดงเมื่อมีการ Check-in จริง</p>
                    </div>
                </div>

                <!-- Summary Tables -->
                <div class="content-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="table-section">
                        <div class="section-header"><h2><i class="fas fa-trophy"></i> Top Teams</h2></div>
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-trophy fa-2x" style="opacity: 0.5;"></i>
                            <p style="margin-top: 16px;">ยังไม่มีข้อมูล</p>
                        </div>
                    </div>
                    <div class="table-section">
                        <div class="section-header"><h2><i class="fas fa-building"></i> Top Branches</h2></div>
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-building fa-2x" style="opacity: 0.5;"></i>
                            <p style="margin-top: 16px;">ยังไม่มีข้อมูล</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photo Gallery Page -->
            <div class="page-content" id="page-gallery" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-images" style="color: var(--primary);"></i> Photo Gallery
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <select id="galleryTeamFilter" style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: 'Prompt', sans-serif;" onchange="filterGallery()">
                            <option value="all">ทุกทีม</option>
                            <option value="A">Team A</option>
                            <option value="B">Team B</option>
                            <option value="C">Team C</option>
                            <option value="D">Team D</option>
                            <option value="E">Team E</option>
                        </select>
                        <select id="galleryTypeFilter" style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: 'Prompt', sans-serif;" onchange="filterGallery()">
                            <option value="all">ทุกประเภท</option>
                            <option value="house">รูปหน้าบ้าน</option>
                            <option value="contract">รูปสัญญา</option>
                        </select>
                        <input type="date" id="galleryDateFilter" style="padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: 'Prompt', sans-serif;" value="2026-01-25" onchange="filterGallery()">
                    </div>
                </div>

                <!-- Gallery Stats -->
                <div class="stat-cards" style="margin-bottom: 24px; grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-images"></i></div>
                        <div class="stat-info">
                            <h3 id="galleryTotalPhotos">0</h3>
                            <p>รูปภาพทั้งหมด</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-home"></i></div>
                        <div class="stat-info">
                            <h3 id="galleryHouseFront">0</h3>
                            <p>รูปหน้าบ้าน</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-file-contract"></i></div>
                        <div class="stat-info">
                            <h3 id="galleryContract">0</h3>
                            <p>รูปสัญญา</p>
                        </div>
                    </div>
                </div>

                <!-- Gallery Grid -->
                <div class="table-section" style="padding: 24px;">
                    <div class="gallery-grid" id="galleryGrid">
                        <!-- Gallery จะถูก load จาก Firestore -->
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 40px; color: var(--text-secondary);">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p style="margin-top: 16px;">กำลังโหลดรูปภาพ...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div style="padding: 20px 0; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); margin-top: 24px;">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">แสดง 1-8 จาก 254 รูปภาพ</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-outline" style="padding: 8px 12px;"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn btn-primary" style="padding: 8px 12px;">1</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;">2</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;">3</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;">...</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;">32</button>
                            <button class="btn btn-outline" style="padding: 8px 12px;"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Leaflet Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===========================
        // Firebase Helper Functions
        // ===========================
        let firestoreCheckins = []; // เก็บข้อมูลจาก Firestore
        
        // แปลง Firestore Timestamp เป็น Date
        function timestampToDate(timestamp) {
            if (!timestamp) return new Date();
            if (timestamp.toDate) return timestamp.toDate();
            if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
            return new Date(timestamp);
        }
        
        // Format วันที่ไทย DD-MM-YYYY
        function formatThaiDate(date) {
            const d = new Date(date);
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = String(d.getFullYear());
            return `${dd}-${mm}-${yyyy}`;
        }
        
        // Format เวลาผ่านไป
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffMinutes = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMinutes < 1) return 'เมื่อสักครู่';
            if (diffMinutes < 60) return `${diffMinutes} นาทีที่แล้ว`;
            if (diffHours < 24) return `${diffHours} ชั่วโมงที่แล้ว`;
            if (diffDays < 7) return `${diffDays} วันที่แล้ว`;
            return formatThaiDate(date);
        }
        
        // ดึงข้อมูล Check-ins จาก Firestore
        async function loadCheckinsFromFirestore() {
            try {
                // console.log('Loading check-ins from Firestore...');
                const querySnapshot = await db.collection('checkins')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                firestoreCheckins = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    firestoreCheckins.push({
                        id: doc.id,
                        ...data,
                        // Normalize location
                        lat: data.location?.lat || 0,
                        lng: data.location?.lng || 0,
                        address: data.location?.address || '',
                        // Normalize photos
                        houseFrontUrl: data.photos?.houseFront || '',
                        contractPhotoUrl: data.photos?.contractPhoto || '',
                        // Time
                        checkinTime: timestampToDate(data.checkinTime || data.createdAt),
                        // Visibility
                        visible: data.visible !== false
                    });
                });
                
                return firestoreCheckins;
            } catch (error) {
                console.error('Error loading check-ins:', error);
                return [];
            }
        }
        
        // อัพเดท Dashboard Stats จากข้อมูลจริง
        function updateDashboardStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // นับ Check-ins วันนี้
            const todayCheckins = firestoreCheckins.filter(c => {
                const checkinDate = new Date(c.checkinTime);
                checkinDate.setHours(0, 0, 0, 0);
                return checkinDate.getTime() === today.getTime();
            });
            
            // นับ Locations ที่มีข้อมูล
            const activeLocations = firestoreCheckins.filter(c => c.lat && c.lng && c.visible).length;
            
            // นับจำนวน Customers ทั้งหมด (unique by contractNumber)
            const uniqueCustomers = new Set(firestoreCheckins.map(c => c.contractNumber).filter(c => c));
            
            // คำนวณ Success Rate (ถ้ามีรูปภาพถือว่าสำเร็จ)
            const withPhotos = firestoreCheckins.filter(c => c.houseFrontUrl).length;
            const successRate = firestoreCheckins.length > 0 
                ? Math.round((withPhotos / firestoreCheckins.length) * 100) 
                : 0;
            
            // อัพเดท UI ด้วย ID
            const statCheckinsToday = document.getElementById('statCheckinsToday');
            const statActiveLocations = document.getElementById('statActiveLocations');
            const statTotalCustomers = document.getElementById('statTotalCustomers');
            const statSuccessRate = document.getElementById('statSuccessRate');
            
            if (statCheckinsToday) statCheckinsToday.textContent = todayCheckins.length;
            if (statActiveLocations) statActiveLocations.textContent = activeLocations;
            if (statTotalCustomers) statTotalCustomers.textContent = uniqueCustomers.size;
            if (statSuccessRate) statSuccessRate.textContent = successRate + '%';
            
            // อัพเดท Photo Gallery Stats
            updatePhotoGalleryStats();
        }
        
        // อัพเดท Photo Gallery Stats
        function updatePhotoGalleryStats() {
            const houseFrontCount = firestoreCheckins.filter(c => c.houseFrontUrl).length;
            const contractPhotoCount = firestoreCheckins.filter(c => c.contractPhotoUrl).length;
            const totalPhotos = houseFrontCount + contractPhotoCount;
            
            // อัพเดท Gallery page stats (ถ้ามี)
            const galleryTotalEl = document.getElementById('galleryTotalPhotos');
            const galleryHouseEl = document.getElementById('galleryHouseFront');
            const galleryContractEl = document.getElementById('galleryContract');
            
            if (galleryTotalEl) galleryTotalEl.textContent = totalPhotos;
            if (galleryHouseEl) galleryHouseEl.textContent = houseFrontCount;
            if (galleryContractEl) galleryContractEl.textContent = contractPhotoCount;
        }
        
        // อัพเดท Reports จากข้อมูล Firestore
        function updateReportsFromFirestore() {
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            // นับ Check-ins เดือนนี้
            const monthCheckins = firestoreCheckins.filter(c => {
                const d = new Date(c.checkinTime);
                return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            });
            
            // คำนวณ Success Rate (มีรูป = สำเร็จ)
            const withPhotos = firestoreCheckins.filter(c => c.houseFrontUrl).length;
            const successRate = firestoreCheckins.length > 0 
                ? Math.round((withPhotos / firestoreCheckins.length) * 100) 
                : 0;
            const pendingRate = 100 - successRate;
            
            // อัพเดท Stat Cards
            const reportCheckinsMonth = document.getElementById('reportCheckinsMonth');
            const reportSuccessRate = document.getElementById('reportSuccessRate');
            
            if (reportCheckinsMonth) reportCheckinsMonth.textContent = monthCheckins.length;
            if (reportSuccessRate) reportSuccessRate.textContent = successRate + '%';
            
            // อัพเดท Donut Chart
            const donutChart = document.getElementById('donutChart');
            const donutValue = document.getElementById('donutValue');
            const legendSuccess = document.getElementById('legendSuccess');
            const legendPending = document.getElementById('legendPending');
            
            if (donutChart) {
                const successDeg = (successRate / 100) * 360;
                donutChart.style.background = firestoreCheckins.length > 0
                    ? `conic-gradient(#10b981 0deg ${successDeg}deg, #f59e0b ${successDeg}deg 360deg)`
                    : 'conic-gradient(#e5e7eb 0deg 360deg)';
            }
            if (donutValue) donutValue.textContent = firestoreCheckins.length;
            if (legendSuccess) legendSuccess.textContent = `สำเร็จ (${successRate}%)`;
            if (legendPending) legendPending.textContent = `รอดำเนินการ (${pendingRate}%)`;
            
            // อัพเดท Bar Chart (7 วันล่าสุด)
            updateBarChart();
            
            // อัพเดท Team Performance
            updateTeamPerformance();
        }
        
        // อัพเดท Bar Chart รายวัน
        function updateBarChart() {
            const barChart = document.getElementById('barChart');
            if (!barChart || firestoreCheckins.length === 0) return;
            
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                d.setHours(0, 0, 0, 0);
                last7Days.push(d);
            }
            
            const dailyCounts = last7Days.map(day => {
                const nextDay = new Date(day);
                nextDay.setDate(nextDay.getDate() + 1);
                return firestoreCheckins.filter(c => {
                    const checkinDate = new Date(c.checkinTime);
                    return checkinDate >= day && checkinDate < nextDay;
                }).length;
            });
            
            const maxCount = Math.max(...dailyCounts, 1);
            const dayNames = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
            
            barChart.innerHTML = dailyCounts.map((count, i) => {
                const height = Math.max((count / maxCount) * 100, 5);
                const dayName = dayNames[last7Days[i].getDay()];
                const dateStr = last7Days[i].getDate();
                return `
                    <div class="bar-item">
                        <div class="bar" style="height: ${height}%;">
                            <span class="bar-value">${count}</span>
                        </div>
                        <span class="bar-label">${dayName} ${dateStr}</span>
                    </div>
                `;
            }).join('');
        }
        
        // อัพเดท Team Performance
        function updateTeamPerformance() {
            const teams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'Z'];
            const teamCounts = {};
            
            teams.forEach(team => {
                teamCounts[team] = firestoreCheckins.filter(c => c.team === team).length;
            });
            
            // Sort by count
            const sortedTeams = Object.entries(teamCounts)
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1]);
            
            // Top Teams table
            const topTeamsContainer = document.querySelector('#page-reports .table-section:first-of-type');
            if (topTeamsContainer && sortedTeams.length > 0) {
                const tableHtml = `
                    <div class="section-header"><h2><i class="fas fa-trophy"></i> Top Teams</h2></div>
                    <table class="data-table">
                        <thead>
                            <tr><th>อันดับ</th><th>ทีม</th><th>Check-ins</th></tr>
                        </thead>
                        <tbody>
                            ${sortedTeams.slice(0, 5).map(([team, count], i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td><span class="team-badge team-badge-sm team-${team.toLowerCase()}">Team ${team}</span></td>
                                    <td><strong>${count}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                topTeamsContainer.innerHTML = tableHtml;
            }
        }
        
        // ==========================================
        // Notification System
        // ==========================================
        let notifications = [];
        
        // Toggle Notification Dropdown
        function toggleNotificationDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        // ปิด Notification Dropdown เมื่อคลิกที่อื่น
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('notificationDropdown');
            const btn = document.getElementById('notificationBtn');
            if (dropdown && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // เพิ่ม Notification
        function addNotification(type, title, desc) {
            const notification = {
                id: Date.now(),
                type: type, // 'checkin', 'warning', 'info'
                title: title,
                desc: desc,
                time: new Date(),
                read: false
            };
            notifications.unshift(notification);
            updateNotificationUI();
        }
        
        // อัพเดท Notification UI
        function updateNotificationUI() {
            const list = document.getElementById('notificationList');
            const countBadge = document.getElementById('notificationCount');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            // อัพเดท Badge
            if (countBadge) {
                countBadge.textContent = unreadCount;
                countBadge.classList.toggle('hidden', unreadCount === 0);
            }
            
            // อัพเดท List
            if (list) {
                if (notifications.length === 0) {
                    list.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>ยังไม่มีการแจ้งเตือน</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = notifications.slice(0, 10).map(n => {
                        const timeAgo = getTimeAgo(n.time);
                        return `
                            <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markNotificationRead(${n.id})">
                                <div class="icon ${n.type}">
                                    <i class="fas ${n.type === 'checkin' ? 'fa-location-check' : n.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                                </div>
                                <div class="content">
                                    <div class="title">${n.title}</div>
                                    <div class="desc">${n.desc}</div>
                                    <div class="time">${timeAgo}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        // Mark Notification as Read
        function markNotificationRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                updateNotificationUI();
            }
        }
        
        // ล้าง Notifications ทั้งหมด
        function clearAllNotifications() {
            notifications = [];
            updateNotificationUI();
        }
        
        // คำนวณ Time Ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'เมื่อสักครู่';
            if (diffMins < 60) return `${diffMins} นาทีที่แล้ว`;
            if (diffHours < 24) return `${diffHours} ชั่วโมงที่แล้ว`;
            return `${diffDays} วันที่แล้ว`;
        }
        
        // ==========================================
        // Customer Stats Update
        // ==========================================
        function updateCustomerStats() {
            // นับลูกค้าจาก Check-ins (unique by contractNumber)
            const uniqueContracts = new Map();
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            firestoreCheckins.forEach(c => {
                if (c.contractNumber && !uniqueContracts.has(c.contractNumber)) {
                    uniqueContracts.set(c.contractNumber, {
                        customerName: c.customerName,
                        branch: c.branch,
                        lastCheckin: c.checkinTime,
                        checkinCount: 1
                    });
                } else if (c.contractNumber) {
                    const existing = uniqueContracts.get(c.contractNumber);
                    existing.checkinCount++;
                    if (new Date(c.checkinTime) > new Date(existing.lastCheckin)) {
                        existing.lastCheckin = c.checkinTime;
                    }
                }
            });
            
            const totalCustomers = uniqueContracts.size;
            
            // Active = มี Check-in ใน 30 วันที่ผ่านมา
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            let activeCount = 0;
            let newThisMonth = 0;
            
            uniqueContracts.forEach((data, contract) => {
                const lastDate = new Date(data.lastCheckin);
                if (lastDate >= thirtyDaysAgo) {
                    activeCount++;
                }
                // ลูกค้าใหม่เดือนนี้ (Check-in แรกเป็นเดือนนี้)
                if (lastDate.getMonth() === thisMonth && lastDate.getFullYear() === thisYear) {
                    // ถ้า check-in count = 1 และเดือนนี้ = ลูกค้าใหม่
                    if (data.checkinCount === 1) {
                        newThisMonth++;
                    }
                }
            });
            
            // อัพเดท UI
            const customerTotalEl = document.getElementById('customerTotal');
            const customerActiveEl = document.getElementById('customerActive');
            const customerNewEl = document.getElementById('customerNewMonth');
            
            if (customerTotalEl) customerTotalEl.textContent = totalCustomers.toLocaleString();
            if (customerActiveEl) customerActiveEl.textContent = activeCount.toLocaleString();
            if (customerNewEl) customerNewEl.textContent = newThisMonth.toLocaleString();
            
            // อัพเดท Customer Table
            updateCustomerTable(uniqueContracts);
        }
        
        // อัพเดท Customer Table
        function updateCustomerTable(customersMap) {
            const tbody = document.getElementById('customersTableBody');
            const info = document.getElementById('customersTableInfo');
            
            if (!tbody) return;
            
            const customers = Array.from(customersMap.entries()).map(([contract, data]) => ({
                contract,
                ...data
            }));
            
            if (customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-users" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 10px;"></i>
                            ยังไม่มีข้อมูลลูกค้า<br>
                            <small>ข้อมูลจะแสดงเมื่อมีการ Check-in</small>
                        </td>
                    </tr>
                `;
                if (info) info.textContent = 'แสดง 0 รายการ';
                return;
            }
            
            // Sort by lastCheckin desc
            customers.sort((a, b) => new Date(b.lastCheckin) - new Date(a.lastCheckin));
            
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            
            tbody.innerHTML = customers.map(c => {
                const lastDate = new Date(c.lastCheckin);
                const isActive = lastDate >= thirtyDaysAgo;
                const formattedDate = formatThaiDate(c.lastCheckin);
                
                return `
                    <tr>
                        <td><strong>${c.customerName || '-'}</strong></td>
                        <td><code>${c.contract}</code></td>
                        <td>${c.branch || '-'}</td>
                        <td>${formattedDate}</td>
                        <td>${c.checkinCount}</td>
                        <td><span class="checkin-status ${isActive ? 'active' : 'pending'}">${isActive ? 'Active' : 'Pending'}</span></td>
                    </tr>
                `;
            }).join('');
            
            if (info) info.textContent = `แสดง ${customers.length} รายการ`;
        }
        
        // Format Thai Date
        function formatThaiDate(dateStr) {
            try {
                const date = new Date(dateStr);
                const day = date.getDate();
                const months = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                const month = months[date.getMonth()];
                const year = date.getFullYear() + 543; // Buddhist Era
                return `${day} ${month} ${year}`;
            } catch (e) {
                return '-';
            }
        }
        
        // อัพเดท Recent Check-ins
        function updateRecentCheckins() {
            const container = document.getElementById('recentCheckinsListContainer');
            if (!container) return;
            
            // แสดง 5 รายการล่าสุด
            const recentItems = firestoreCheckins.slice(0, 5);
            
            if (recentItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p style="margin-top: 16px;">ยังไม่มีข้อมูล Check-in</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentItems.map((item, index) => {
                // สร้าง avatar จากชื่อ (2 ตัวอักษรแรก)
                const avatarText = (item.customerName || '-').substring(0, 2);
                // คำนวณเวลาที่ผ่านไป
                const timeAgo = formatTimeAgo(item.checkinTime);
                const actualTime = item.checkinTime.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                
                return `
                    <div class="checkin-item" data-checkin-id="${index}">
                        <span class="team-badge team-badge-sm team-${(item.team || 'a').toLowerCase()}">${item.team || '-'}</span>
                        <div class="checkin-avatar">${avatarText}</div>
                        <div class="checkin-info">
                            <div class="name">${item.customerName || '-'}</div>
                            <div class="location"><i class="fas fa-location-dot"></i> ${item.address || item.branch || 'ไม่มีที่อยู่'}</div>
                            <div class="time"><i class="far fa-clock"></i> ${timeAgo} <span class="actual-time">(${actualTime})</span></div>
                        </div>
                        <div class="checkin-actions">
                            <label class="toggle-switch" title="แสดงบนแผนที่">
                                <input type="checkbox" ${item.visible ? 'checked' : ''} onchange="toggleCheckinVisibility('${item.id}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="checkin-navigate" ondblclick="focusOnMap(${item.lat}, ${item.lng}, '${item.id}')" title="Double-click เพื่อไปที่จุดนี้บนแผนที่">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle visibility ของ Check-in
        async function toggleCheckinVisibility(docId, visible) {
            try {
                await db.collection('checkins').doc(docId).update({
                    visible: visible,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // อัพเดท local data
                const item = firestoreCheckins.find(c => c.id === docId);
                if (item) item.visible = visible;
                
                // Refresh maps
                updateMapMarkersFromFirestore();
                updateMapViewMarkersFromFirestore();
            } catch (error) {
                console.error('Error updating visibility:', error);
            }
        }
        
        // อัพเดท Markers บนแผนที่หลัก (Dashboard) จาก Firestore
        function updateMapMarkersFromFirestore() {
            if (!map) return;
            
            // Clear existing markers (except HQ)
            markers.forEach(m => map.removeLayer(m));
            markers.length = 0;
            
            firestoreCheckins.forEach((item, index) => {
                if (!item.visible || !item.lat || !item.lng) return;
                if (!teamVisibility[item.team]) return;
                
                const marker = L.marker([item.lat, item.lng], { icon: createCustomIcon(item.team) })
                    .bindPopup(`
                        <div style="font-family: 'Prompt', sans-serif; padding: 8px; min-width: 200px;">
                            <strong style="font-size: 1rem;">${item.customerName || '-'}</strong>
                            <span style="font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; color: #64748b; margin-left: 8px;">Team ${item.team}</span>
                            <br><br>
                            <span style="color: #64748b;"><i class="fas fa-file-contract"></i> ${item.contractNumber || '-'}</span><br>
                            <span style="color: #64748b;"><i class="fas fa-building"></i> ${item.branch || '-'} (${item.zone || '-'})</span><br>
                            <span style="color: #64748b;"><i class="fas fa-location-dot"></i> ${item.address || 'ไม่มีที่อยู่'}</span><br>
                            <span style="color: #94a3b8; font-size: 0.8rem;"><i class="far fa-clock"></i> ${formatThaiDate(item.checkinTime)} ${item.checkinTime.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</span>
                            ${item.houseFrontUrl ? `<br><br><img src="${item.houseFrontUrl}" style="width:100%;max-width:180px;border-radius:8px;">` : ''}
                        </div>
                    `)
                    .on('click', function() {
                        selectedCheckin = {
                            ...item,
                            location: { lat: item.lat, lng: item.lng }
                        };
                        document.getElementById('navigateBtn').style.background = '#22c55e';
                    })
                    .addTo(map);
                markers.push(marker);
            });
        }
        
        // อัพเดท Markers บน Map View จาก Firestore
        function updateMapViewMarkersFromFirestore() {
            if (!mapView) return;
            
            // Clear existing layers
            mapViewLayers.forEach(layer => mapView.removeLayer(layer));
            mapViewLayers = [];
            
            const filterTeam = document.getElementById('mapViewTeamFilter')?.value || 'all';
            
            firestoreCheckins.forEach((item) => {
                if (!item.visible || !item.lat || !item.lng) return;
                
                // Map View แสดงทุก marker ที่ visible (กรองเฉพาะทีมถ้าเลือก)
                const matchesDropdown = filterTeam === 'all' || item.team === filterTeam;
                
                if (matchesDropdown) {
                    const marker = L.marker([item.lat, item.lng], { icon: createCustomIcon(item.team) })
                        .bindPopup(`
                            <div style="font-family: 'Prompt', sans-serif; padding: 8px; min-width: 200px;">
                                <strong style="font-size: 1rem;">${item.customerName || '-'}</strong>
                                <span style="font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; color: #64748b; margin-left: 8px;">Team ${item.team}</span>
                                <br><br>
                                <span style="color: #64748b;"><i class="fas fa-file-contract"></i> ${item.contractNumber || '-'}</span><br>
                                <span style="color: #64748b;"><i class="fas fa-building"></i> ${item.branch || '-'}</span><br>
                                <span style="color: #64748b;"><i class="fas fa-location-dot"></i> ${item.address || 'ไม่มีที่อยู่'}</span>
                            </div>
                        `)
                        .on('click', function() {
                            selectedCheckin = {
                                ...item,
                                location: { lat: item.lat, lng: item.lng }
                            };
                        })
                        .addTo(mapView);
                    mapViewLayers.push(marker);
                }
            });
        }
        
        // อัพเดทตาราง Check-ins List
        function updateCheckinsTable() {
            const tbody = document.getElementById('checkinsTableBody');
            const mainTbody = document.getElementById('mainCheckinsTableBody');
            
            // สร้าง HTML สำหรับตาราง
            const generateTableRows = (includeIndex = true) => {
                if (firestoreCheckins.length === 0) {
                    return `<tr><td colspan="${includeIndex ? 8 : 7}" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        ไม่มีข้อมูล Check-in
                    </td></tr>`;
                }
                
                return firestoreCheckins.map((item, index) => `
                    <tr data-checkin-id="${item.id}">
                        ${includeIndex ? `<td>${index + 1}</td>` : ''}
                        ${!includeIndex ? `<td><span class="team-badge team-${item.team?.toLowerCase() || 'a'}">${item.team || '-'}</span></td>` : ''}
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; border-radius: 8px; overflow: hidden; background: #f1f5f9; display: flex; align-items: center; justify-content: center;">
                                    ${item.houseFrontUrl 
                                        ? `<img src="${item.houseFrontUrl}" style="width:100%;height:100%;object-fit:cover;">` 
                                        : '<i class="fas fa-home" style="color:#94a3b8;"></i>'
                                    }
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${item.customerName || '-'}</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">${item.contractNumber || '-'}</div>
                                </div>
                            </div>
                        </td>
                        ${includeIndex ? `<td><span class="team-tag">Team ${item.team || '-'}</span></td>` : ''}
                        <td>${item.branch || item.address || '-'}</td>
                        ${includeIndex ? `<td>${item.zone || '-'}</td>` : `<td><code>${item.lat?.toFixed(4) || '-'}, ${item.lng?.toFixed(4) || '-'}</code></td>`}
                        <td>${formatThaiDate(item.checkinTime)} ${item.checkinTime?.toLocaleTimeString?.('th-TH', {hour:'2-digit', minute:'2-digit'}) || ''}</td>
                        <td><span class="checkin-status ${item.visible ? 'active' : 'pending'}">${item.visible ? 'Active' : 'Pending'}</span></td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" ${item.visible ? 'checked' : ''} onchange="toggleCheckinVisibility('${item.id}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                        ${includeIndex ? `<td>
                            <button onclick="viewCheckinDetail('${item.id}')" style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 5px;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>` : ''}
                    </tr>
                `).join('');
            };
            
            // อัพเดทตาราง Check-ins List (หน้า Check-ins)
            if (tbody) {
                tbody.innerHTML = generateTableRows(true);
            }
            
            // อัพเดทตาราง All Check-ins Data (หน้า Dashboard)
            if (mainTbody) {
                mainTbody.innerHTML = generateTableRows(false);
            }
        }
        
        // ดูรายละเอียด Check-in
        function viewCheckinDetail(docId) {
            const item = firestoreCheckins.find(c => c.id === docId);
            if (!item) return;
            
            alert(`รายละเอียด Check-in\n\nลูกค้า: ${item.customerName}\nเลขสัญญา: ${item.contractNumber}\nสาขา: ${item.branch}\nเขต: ${item.zone}\nที่อยู่: ${item.address}\nพิกัด: ${item.lat}, ${item.lng}`);
        }
        
        // ===========================
        // Real-time Listener
        // ===========================
        let realtimeUnsubscribe = null;
        let isInitialLoad = true; // ป้องกันการแสดง notification ตอนโหลดครั้งแรก
        
        function startRealtimeListener() {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe(); // หยุด listener เก่า
            }
            
            isInitialLoad = true; // Reset flag เมื่อเริ่ม listener ใหม่
            // console.log('Starting real-time listener...');
            
            realtimeUnsubscribe = db.collection('checkins')
                .orderBy('createdAt', 'desc')
                .limit(100)
                .onSnapshot(
                    (snapshot) => {
                        // ตรวจสอบว่ามีการเปลี่ยนแปลงจริงหรือไม่
                        let hasChanges = false;
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                hasChanges = true;
                                // แสดง Toast และ Notification เมื่อมี check-in ใหม่ (ยกเว้นตอนโหลดครั้งแรก)
                                if (!isInitialLoad) {
                                    const data = change.doc.data();
                                    showRealtimeToast('เช็คอินใหม่!', data.customerName);
                                    addNotification('checkin', 'Check-in ใหม่', `${data.customerName || 'ลูกค้า'} - ทีม ${data.team || '-'}`);
                                }
                            } else if (change.type === 'modified') {
                                hasChanges = true;
                            } else if (change.type === 'removed') {
                                hasChanges = true;
                            }
                        });
                        
                        // หลังจาก snapshot แรก ตั้ง flag เป็น false
                        isInitialLoad = false;
                        
                        // อัพเดทข้อมูลใน memory
                        firestoreCheckins = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            firestoreCheckins.push({
                                id: doc.id,
                                ...data,
                                lat: data.location?.lat || 0,
                                lng: data.location?.lng || 0,
                                address: data.location?.address || '',
                                houseFrontUrl: data.photos?.houseFront || '',
                                contractPhotoUrl: data.photos?.contractPhoto || '',
                                checkinTime: timestampToDate(data.checkinTime || data.createdAt),
                                visible: data.visible !== false
                            });
                        });
                        
                        // Refresh UI
                        updateDashboardStats();
                        updateRecentCheckins();
                        updateMapMarkersFromFirestore();
                        updateCheckinsTable();
                        updatePhotoGallery();
                        updateCustomerStats();
                        updateReportsFromFirestore();
                        
                        // อัพเดท Live Badge
                        updateLiveBadge();
                    },
                    (error) => {
                        console.error('Real-time listener error:', error);
                        // Fallback to polling
                        setTimeout(() => startRealtimeListener(), 5000);
                    }
                );
        }
        
        // แสดง Toast เมื่อมี Check-in ใหม่
        function showRealtimeToast(title, customerName) {
            const toastContainer = document.getElementById('realtimeToast') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = 'realtime-toast';
            toast.innerHTML = `
                <i class="fas fa-map-marker-alt" style="color: #10b981;"></i>
                <div>
                    <strong>${title}</strong>
                    <div style="font-size: 0.85rem; color: #64748b;">${customerName || 'ลูกค้าใหม่'}</div>
                </div>
            `;
            toastContainer.appendChild(toast);
            
            // Auto remove
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'realtimeToast';
            container.style.cssText = 'position:fixed;top:80px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;';
            document.body.appendChild(container);
            
            // Add toast styles
            const style = document.createElement('style');
            style.textContent = `
                .realtime-toast {
                    background: white;
                    padding: 14px 18px;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    min-width: 250px;
                    animation: slideIn 0.3s ease;
                    transition: all 0.3s ease;
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateX(100%); }
                    to { opacity: 1; transform: translateX(0); }
                }
            `;
            document.head.appendChild(style);
            
            return container;
        }
        
        // อัพเดท Live Badge (สถานะ Real-time)
        function updateLiveBadge() {
            let badge = document.getElementById('liveBadge');
            if (!badge) {
                // สร้าง badge ถ้ายังไม่มี
                const header = document.querySelector('.header-left h1');
                if (header) {
                    badge = document.createElement('span');
                    badge.id = 'liveBadge';
                    badge.style.cssText = 'display:inline-flex;align-items:center;gap:5px;background:#10b981;color:white;font-size:0.7rem;padding:3px 8px;border-radius:12px;margin-left:10px;animation:pulse 2s infinite;';
                    badge.innerHTML = '<span style="width:6px;height:6px;background:white;border-radius:50%;"></span> LIVE';
                    header.appendChild(badge);
                    
                    // Add pulse animation
                    const style = document.createElement('style');
                    style.textContent = '@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }';
                    document.head.appendChild(style);
                }
            }
        }
        
        // โหลดข้อมูลเมื่อเปิดหน้า
        async function initializeFirestoreData() {
            await loadCheckinsFromFirestore();
            updateDashboardStats();
            updateRecentCheckins();
            updateMapMarkersFromFirestore();
            updateCheckinsTable();
            updatePhotoGallery();
            updateCustomerStats();
            
            // เริ่ม Real-time Listener
            startRealtimeListener();
        }
        
        // หยุด Listener เมื่อปิดหน้า
        window.addEventListener('beforeunload', () => {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
            }
        });
        
        // เรียกใช้เมื่อ DOM พร้อม
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirestoreData();
        });
        
        // OpenStreetMap tiles (default)
        const osmTileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        
        // ===========================
        // HQ (สำนักงานใหญ่) - 13°47'39.9"N 100°41'23.7"E
        // ===========================
        const HQ_LOCATION = {
            lat: 13.794417,  // 13°47'39.9"N
            lng: 100.689917, // 100°41'23.7"E
            name: 'Advance Group Asia กำจัดปลวก ทำความสะอาด',
            address: 'สำนักงานใหญ่ 234/9 ระหว่าง 48 ซอย เสรีไทย 46 แขวงคันนายาว เขตคันนายาว กรุงเทพมหานคร 10230',
            googleMapsUrl: 'https://maps.app.goo.gl/xHfpwNhuuMNBnBHQ7'
        };
        let hqMarker = null;
        let hqMarkerMapView = null;

        // Initialize Map
        const map = L.map('map').setView([13.7400, 100.5400], 13);
        
        // Add tile layer (OpenStreetMap)
        L.tileLayer(osmTileUrl, {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add HQ Marker
        function addHQMarker() {
            const hqIcon = L.divIcon({
                className: 'hq-marker-wrapper',
                html: `
                    <div class="hq-marker">
                        <i class="fas fa-building" style="color: white; font-size: 18px;"></i>
                    </div>
                `,
                iconSize: [44, 44],
                iconAnchor: [22, 22]
            });
            
            hqMarker = L.marker([HQ_LOCATION.lat, HQ_LOCATION.lng], { icon: hqIcon })
                .bindPopup(`
                    <div style="text-align: center; padding: 12px; min-width: 220px;">
                        <div style="font-size: 1.1rem; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">
                            <i class="fas fa-building"></i> ${HQ_LOCATION.name}
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 8px; line-height: 1.5;">
                            ${HQ_LOCATION.address}
                        </div>
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 12px;">
                            <i class="fas fa-map-pin"></i> ${HQ_LOCATION.lat.toFixed(6)}, ${HQ_LOCATION.lng.toFixed(6)}
                        </div>
                        <a href="${HQ_LOCATION.googleMapsUrl}" 
                           target="_blank" 
                           style="display: inline-block; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; font-weight: 500;">
                            <i class="fas fa-directions"></i> นำทาง Google Maps
                        </a>
                    </div>
                `)
                .addTo(map);
        }
        
        // เรียกใช้ตอนโหลด
        addHQMarker();
        
        // ไปที่ HQ
        function goToHQ() {
            map.setView([HQ_LOCATION.lat, HQ_LOCATION.lng], 16, { animate: true });
            if (hqMarker) {
                hqMarker.openPopup();
            }
        }
        
        // Focus ไปที่จุด Check-in บนแผนที่ (double-click จาก list)
        function focusOnMap(lat, lng, checkinId) {
            if (!lat || !lng) {
                alert('ไม่พบพิกัดของลูกค้านี้');
                return;
            }
            
            // Zoom ไปที่จุดนั้น
            map.setView([lat, lng], 18, { animate: true });
            
            // หา marker ที่ตรงกับพิกัดและเปิด popup
            markers.forEach(marker => {
                const markerLatLng = marker.getLatLng();
                if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                    setTimeout(() => marker.openPopup(), 300);
                }
            });
            
            // อัพเดท selectedCheckin
            const item = firestoreCheckins.find(c => c.id === checkinId);
            if (item) {
                selectedCheckin = {
                    ...item,
                    location: { lat, lng }
                };
                const navBtn = document.getElementById('navigateBtn');
                if (navBtn) navBtn.style.background = '#22c55e';
            }
        }
        
        // ตัวแปรเก็บ check-in ที่เลือก
        let selectedCheckin = null;
        
        // นำทางไปยังจุดที่เลือก (เปิด Google Maps)
        function navigateToSelected() {
            if (!selectedCheckin || !selectedCheckin.location) {
                alert('กรุณาเลือกจุด Check-in บนแผนที่ก่อน');
                return;
            }
            
            const lat = selectedCheckin.location.lat;
            const lng = selectedCheckin.location.lng;
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }
        
        // ไปที่ HQ ใน Map View
        function goToHQMapView() {
            if (mapView) {
                mapView.setView([HQ_LOCATION.lat, HQ_LOCATION.lng], 16, { animate: true });
                if (hqMarkerMapView) {
                    hqMarkerMapView.openPopup();
                }
            }
        }
        
        // Add HQ Marker to Map View
        function addHQMarkerToMapView() {
            if (!mapView || hqMarkerMapView) return;
            
            const hqIcon = L.divIcon({
                className: 'hq-marker-wrapper',
                html: `
                    <div class="hq-marker">
                        <i class="fas fa-building" style="color: white; font-size: 18px;"></i>
                    </div>
                `,
                iconSize: [44, 44],
                iconAnchor: [22, 22]
            });
            
            hqMarkerMapView = L.marker([HQ_LOCATION.lat, HQ_LOCATION.lng], { icon: hqIcon })
                .bindPopup(`
                    <div style="text-align: center; padding: 12px; min-width: 220px;">
                        <div style="font-size: 1.1rem; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">
                            <i class="fas fa-building"></i> ${HQ_LOCATION.name}
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 8px; line-height: 1.5;">
                            ${HQ_LOCATION.address}
                        </div>
                        <div style="font-size: 0.75rem; color: #999; margin-bottom: 12px;">
                            <i class="fas fa-map-pin"></i> ${HQ_LOCATION.lat}, ${HQ_LOCATION.lng}
                        </div>
                        <a href="${HQ_LOCATION.googleMapsUrl}" target="_blank" 
                           style="display: inline-block; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; font-weight: 500;">
                            <i class="fas fa-directions"></i> นำทาง Google Maps
                        </a>
                    </div>
                `)
                .addTo(mapView);
        }

        // Initialize Map View (Second Map)
        let mapView = null;
        let mapViewLayers = [];

        function initMapView() {
            if (!mapView) {
                mapView = L.map('map-view').setView([13.7400, 100.5400], 13);
                L.tileLayer(osmTileUrl, {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(mapView);
                
                // Add click handler for Map View distance measurement
                mapView.on('click', function(e) {
                    if (!measureModeFull) return;
                    
                    const pointNum = measurePointsFull.length + 1;
                    const pointIcon = L.divIcon({
                        className: 'measure-point',
                        html: `<div style="background: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold;">${pointNum}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const marker = L.marker(e.latlng, { icon: pointIcon }).addTo(mapView);
                    measureMarkersFull.push(marker);
                    measurePointsFull.push(e.latlng);
                    
                    updateMeasureLineFull();
                    
                    const distFull = calculateTotalDistanceFull();
                    if (measurePointsFull.length === 1) {
                         document.getElementById('distanceValueFull').innerHTML = '0.00 <span>กม.</span>';
                    } else {
                        if (distFull < 1) {
                            document.getElementById('distanceValueFull').innerHTML = `${(distFull * 1000).toFixed(0)} <span>เมตร</span>`;
                        } else {
                            document.getElementById('distanceValueFull').innerHTML = `${distFull.toFixed(2)} <span>กม.</span>`;
                        }
                    }
                });
            }
            // Add HQ Marker to Map View
            addHQMarkerToMapView();
            
            // Update markers whenever map view is shown (use team filter version)
            updateMapViewMarkersWithTeamFilter();
        }

        // Custom marker icon generator
        function createCustomIcon(team) {
            // Define gradients based on team (16 teams: A-O, Z)
            const gradients = {
                'A': 'linear-gradient(135deg, #ef4444, #dc2626)', // Red
                'B': 'linear-gradient(135deg, #10b981, #059669)', // Green
                'C': 'linear-gradient(135deg, #f59e0b, #d97706)', // Orange
                'D': 'linear-gradient(135deg, #0ea5e9, #0284c7)', // Blue
                'E': 'linear-gradient(135deg, #8b5cf6, #7c3aed)', // Purple
                'F': 'linear-gradient(135deg, #ec4899, #db2777)', // Pink
                'G': 'linear-gradient(135deg, #14b8a6, #0d9488)', // Teal
                'H': 'linear-gradient(135deg, #f97316, #ea580c)', // Deep Orange
                'I': 'linear-gradient(135deg, #6366f1, #4f46e5)', // Indigo
                'J': 'linear-gradient(135deg, #84cc16, #65a30d)', // Lime
                'K': 'linear-gradient(135deg, #06b6d4, #0891b2)', // Cyan
                'L': 'linear-gradient(135deg, #a855f7, #9333ea)', // Violet
                'M': 'linear-gradient(135deg, #f43f5e, #e11d48)', // Rose
                'N': 'linear-gradient(135deg, #22c55e, #16a34a)', // Emerald
                'O': 'linear-gradient(135deg, #eab308, #ca8a04)', // Yellow
                'Z': 'linear-gradient(135deg, #64748b, #475569)'  // Slate (Special Team)
            };

            const gradient = gradients[team] || 'linear-gradient(135deg, #0ea5e9, #06b6d4)'; // Default Blue

            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: ${gradient}; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"></div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
        }

        // Markers array - จะถูก populate จาก Firestore
        const markers = [];
        
        // Note: Markers จะถูกสร้างผ่าน updateMapMarkersFromFirestore() เมื่อโหลดข้อมูล

        // Function to update markers on Map View based on filter - ใช้ Firestore data
        function updateMapViewMarkers() {
            updateMapViewMarkersFromFirestore();
        }
        
        // Filter function for Map View
        function filterMapView() {
             updateMapViewMarkersFromFirestore();
        }

        // Toggle marker visibility (ใช้กับ Firestore markers)
        function toggleMarker(index, visible) {
            if (markers[index]) {
                if (visible) {
                    markers[index].addTo(map);
                } else {
                    map.removeLayer(markers[index]);
                }
            }
        }

        // Sync toggle between Recent Check-ins and All Check-ins Data table
        function syncToggleMarker(index, visible) {
            // Update map marker
            toggleMarker(index, visible);
            
            // Sync all checkboxes with the same checkin ID
            const allToggles = document.querySelectorAll(`[data-checkin-id="${index}"] input[type="checkbox"]`);
            allToggles.forEach(toggle => {
                toggle.checked = visible;
            });
        }

        // ===========================
        // Team Filter for Map
        // ===========================
        let teamVisibility = {
            'A': true, 'B': true, 'C': true, 'D': true, 'E': true,
            'F': true, 'G': true, 'H': true, 'I': true, 'J': true,
            'K': true, 'L': true, 'M': true, 'N': true, 'O': true, 'Z': true
        };

        function toggleTeamFilterMenu() {
            const menu = document.getElementById('teamFilterMenu');
            menu.classList.toggle('active');
            // Close Map View team filter if open
            const mapViewMenu = document.getElementById('mapViewTeamFilterMenu');
            if (mapViewMenu) mapViewMenu.classList.remove('active');
        }

        // Map View Team Filter Functions
        let mapViewTeamVisibility = {
            'A': true, 'B': true, 'C': true, 'D': true, 'E': true,
            'F': true, 'G': true, 'H': true, 'I': true, 'J': true,
            'K': true, 'L': true, 'M': true, 'N': true, 'O': true, 'Z': true
        };

        function toggleMapViewTeamFilter() {
            const menu = document.getElementById('mapViewTeamFilterMenu');
            menu.classList.toggle('active');
            // Close dashboard team filter if open
            const dashboardMenu = document.getElementById('teamFilterMenu');
            if (dashboardMenu) dashboardMenu.classList.remove('active');
        }

        function filterMapViewByTeam() {
            const checkboxes = document.querySelectorAll('#mapViewTeamFilterMenu .team-checkbox input');
            checkboxes.forEach(cb => {
                mapViewTeamVisibility[cb.value] = cb.checked;
            });
            updateMapViewMarkersWithTeamFilter();
        }

        function mapViewSelectAllTeams() {
            const checkboxes = document.querySelectorAll('#mapViewTeamFilterMenu .team-checkbox input');
            checkboxes.forEach(cb => {
                cb.checked = true;
                mapViewTeamVisibility[cb.value] = true;
            });
            updateMapViewMarkersWithTeamFilter();
        }

        function mapViewDeselectAllTeams() {
            const checkboxes = document.querySelectorAll('#mapViewTeamFilterMenu .team-checkbox input');
            checkboxes.forEach(cb => {
                cb.checked = false;
                mapViewTeamVisibility[cb.value] = false;
            });
            updateMapViewMarkersWithTeamFilter();
        }

        function updateMapViewMarkersWithTeamFilter() {
            if (!mapView) return;
            
            // Clear existing layers
            mapViewLayers.forEach(layer => mapView.removeLayer(layer));
            mapViewLayers = [];
            
            // Re-add markers based on team visibility จาก Firestore data
            firestoreCheckins.forEach(item => {
                if (!item.lat || !item.lng || !item.visible) return;
                if (mapViewTeamVisibility[item.team]) {
                    const marker = L.marker([item.lat, item.lng], { icon: createCustomIcon(item.team) })
                        .bindPopup(`
                            <div style="font-family: 'Prompt', sans-serif; padding: 8px; min-width: 200px;">
                                <strong style="font-size: 1rem;">${item.customerName || '-'}</strong>
                                <span style="font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; color: #64748b; margin-left: 8px;">Team ${item.team}</span>
                                <br><br>
                                <span style="color: #64748b;"><i class="fas fa-file-contract"></i> ${item.contractNumber || '-'}</span><br>
                                <span style="color: #64748b;"><i class="fas fa-building"></i> ${item.branch || '-'}</span><br>
                                <span style="color: #64748b;"><i class="fas fa-location-dot"></i> ${item.address || 'ไม่มีที่อยู่'}</span>
                            </div>
                        `)
                        .addTo(mapView);
                    mapViewLayers.push(marker);
                }
            });
        }

        function filterByTeam(team, visible) {
            teamVisibility[team] = visible;
            updateMarkersVisibility();
            updateCheckinListVisibility();
        }

        function selectAllTeams(selectAll) {
            const checkboxes = document.querySelectorAll('.team-filter-grid input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
            });
            
            // Update teamVisibility object
            Object.keys(teamVisibility).forEach(team => {
                teamVisibility[team] = selectAll;
            });
            
            updateMarkersVisibility();
            updateCheckinListVisibility();
        }

        function updateMarkersVisibility() {
            // Update markers on main map จาก Firestore data
            firestoreCheckins.forEach((item, index) => {
                if (!markers[index]) return;
                if (teamVisibility[item.team] && item.visible) {
                    markers[index].addTo(map);
                } else {
                    map.removeLayer(markers[index]);
                }
            });

            // Update markers on Map View if it exists
            if (mapView) {
                updateMapViewMarkersFromFirestore();
            }
        }

        function updateCheckinListVisibility() {
            // Show/hide checkin items based on team filter
            const checkinItems = document.querySelectorAll('.checkins-list .checkin-item');
            checkinItems.forEach(item => {
                const teamBadge = item.querySelector('.team-badge');
                if (teamBadge) {
                    const team = teamBadge.textContent.trim();
                    if (teamVisibility[team]) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        }

        // Close team filter menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.team-filter-dropdown')) {
                const menu = document.getElementById('teamFilterMenu');
                if (menu) menu.classList.remove('active');
                const mapViewMenu = document.getElementById('mapViewTeamFilterMenu');
                if (mapViewMenu) mapViewMenu.classList.remove('active');
            }
        });

        // Filter Panel Toggle
        function toggleFilter() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('active');
        }

        // Table Sorting
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const th = table.querySelectorAll('thead th')[columnIndex];
            
            // Determine sort direction
            const isAsc = th.classList.contains('sort-asc');
            
            // Reset all headers
            table.querySelectorAll('thead th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                const icon = header.querySelector('.sort-icon');
                if (icon) {
                    icon.classList.remove('fa-sort-up', 'fa-sort-down');
                    icon.classList.add('fa-sort');
                }
            });
            
            // Set new sort direction
            if (isAsc) {
                th.classList.add('sort-desc');
                th.querySelector('.sort-icon').classList.remove('fa-sort');
                th.querySelector('.sort-icon').classList.add('fa-sort-down');
            } else {
                th.classList.add('sort-asc');
                th.querySelector('.sort-icon').classList.remove('fa-sort');
                th.querySelector('.sort-icon').classList.add('fa-sort-up');
            }
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].textContent.trim().toLowerCase();
                let bValue = b.cells[columnIndex].textContent.trim().toLowerCase();
                
                // Try numeric sort
                const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
                const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAsc ? bNum - aNum : aNum - bNum;
                }
                
                // String sort
                if (isAsc) {
                    return bValue.localeCompare(aValue, 'th');
                } else {
                    return aValue.localeCompare(bValue, 'th');
                }
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Page Navigation
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show selected page
            const selectedPage = document.getElementById('page-' + pageName);
            if (selectedPage) {
                selectedPage.style.display = 'block';
                // Initialize map if switching to mapview
                if (pageName === 'mapview') {
                    setTimeout(() => {
                        initMapView();
                        mapView.invalidateSize();
                    }, 100);
                } else if (pageName === 'dashboard') {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            }
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });
        }

        // Apply Filters (mockup - just shows alert)
        function applyFilters() {
            const team = document.getElementById('filterTeam').value;
            const zone = document.getElementById('filterZone').value;
            const branch = document.getElementById('filterBranch').value;
            const date = document.getElementById('filterDate').value;
            
            alert(`กำลังกรองข้อมูล:\n- ทีม: ${team}\n- เขต: ${zone}\n- สาขา: ${branch}\n- วันที่: ${date}`);
        }

        // Distance Measurement - Multi-point like Google Maps
        let measureMode = false;
        let measurePoints = [];
        let measureMarkers = [];
        let measureLine = null;
        let totalDistance = 0;

        function toggleMeasure() {
            measureMode = !measureMode;
            const btn = document.getElementById('measureBtn');
            const panel = document.getElementById('distancePanel');
            
            if (measureMode) {
                // ปิด radius mode ถ้าเปิดอยู่
                if (radiusMode) {
                    toggleRadius();
                }
                
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> ยกเลิก';
                panel.classList.add('active');
                document.getElementById('distanceInfo').innerHTML = 'คลิกเพื่อเพิ่มจุด <button onclick="clearMeasurement()" style="background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; margin-left: 8px;"><i class="fas fa-trash"></i> ล้าง</button>';
                document.getElementById('distanceValue').innerHTML = '0.00 <span>กม.</span>';
                totalDistance = 0;
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-ruler"></i> วัดระยะ';
                panel.classList.remove('active');
                clearMeasurement();
            }
        }

        function clearMeasurement() {
            measurePoints = [];
            measureMarkers.forEach(m => map.removeLayer(m));
            measureMarkers = [];
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            totalDistance = 0;
            if (measureMode) {
                document.getElementById('distanceValue').innerHTML = '0.00 <span>กม.</span>';
            }
        }

        // ===========================
        // Radius Circle Measurement - DRAG TO DRAW (like PowerPoint/Figma)
        // ===========================
        let radiusMode = false;
        let radiusCircles = [];       // Array of {circle, centerMarker, resizeHandle, center, radius}
        let isDrawing = false;
        let drawStartPoint = null;
        let currentDrawCircle = null;
        let selectedCircleIndex = null;
        let isResizing = false;
        let resizingCircleIndex = null;
        let isMapFullScreen = false;

        // Toggle Full Screen สำหรับแผนที่
        function toggleMapFullScreen() {
            const mapSection = document.querySelector('.map-section');
            const btn = document.getElementById('fullScreenBtn');
            
            isMapFullScreen = !isMapFullScreen;
            
            if (isMapFullScreen) {
                mapSection.classList.add('fullscreen');
                btn.innerHTML = '<i class="fas fa-compress"></i> Exit';
                document.body.style.overflow = 'hidden';
            } else {
                mapSection.classList.remove('fullscreen');
                btn.innerHTML = '<i class="fas fa-expand"></i> Full Screen';
                document.body.style.overflow = '';
            }
            
            // Resize map หลังจาก DOM update
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 100);
        }
        
        // ESC key เพื่อออกจาก fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isMapFullScreen) {
                toggleMapFullScreen();
            }
        });

        function toggleRadius() {
            radiusMode = !radiusMode;
            const btn = document.getElementById('radiusBtn');
            const panel = document.getElementById('radiusPanel');
            
            if (radiusMode) {
                // ปิด measure mode ถ้าเปิดอยู่
                if (measureMode) {
                    toggleMeasure();
                }
                
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> ยกเลิก';
                panel.classList.add('active');
                
                document.getElementById('radiusInfo').innerHTML = '<i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม';
                document.getElementById('radiusValue').innerHTML = '0 <span>เมตร</span>';
                
                // เปลี่ยน cursor
                document.getElementById('map').style.cursor = 'crosshair';
                
                // Disable map dragging while in radius mode (จะ enable เมื่อไม่ได้ draw)
                map.dragging.enable();
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-circle"></i> วัดรัศมี';
                panel.classList.remove('active');
                
                // คืน cursor
                document.getElementById('map').style.cursor = '';
                map.dragging.enable();
            }
        }

        function clearRadius() {
            // ลบวงกลมทั้งหมด
            radiusCircles.forEach(item => {
                map.removeLayer(item.circle);
                map.removeLayer(item.centerMarker);
                if (item.deleteMarker) {
                    map.removeLayer(item.deleteMarker);
                }
                if (item.resizeHandle) {
                    map.removeLayer(item.resizeHandle);
                }
            });
            radiusCircles = [];
            selectedCircleIndex = null;
            
            if (currentDrawCircle) {
                map.removeLayer(currentDrawCircle);
                currentDrawCircle = null;
            }
            
            if (radiusMode) {
                document.getElementById('radiusInfo').innerHTML = '<i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม';
                document.getElementById('radiusValue').innerHTML = '0 <span>เมตร</span>';
            }
        }
        
        function calculatePointAtDistance(lat, lng, distanceMeters, bearing) {
            const R = 6371000; // Earth radius in meters
            const d = distanceMeters;
            const brng = bearing * Math.PI / 180;
            const lat1 = lat * Math.PI / 180;
            const lng1 = lng * Math.PI / 180;
            
            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(d/R) + Math.cos(lat1) * Math.sin(d/R) * Math.cos(brng));
            const lng2 = lng1 + Math.atan2(Math.sin(brng) * Math.sin(d/R) * Math.cos(lat1), Math.cos(d/R) - Math.sin(lat1) * Math.sin(lat2));
            
            return {
                lat: lat2 * 180 / Math.PI,
                lng: lng2 * 180 / Math.PI
            };
        }
        
        function updateRadiusInfo(radiusMeters) {
            const km = radiusMeters / 1000;
            if (km < 1) {
                document.getElementById('radiusValue').innerHTML = `${Math.round(radiusMeters)} <span>เมตร</span>`;
            } else {
                document.getElementById('radiusValue').innerHTML = `${km.toFixed(2)} <span>กม.</span>`;
            }
        }
        
        function finalizeCircle(center, radius) {
            // สร้าง circle ถาวร
            const circle = L.circle(center, {
                radius: radius,
                color: '#0ea5e9',
                fillColor: '#0ea5e9',
                fillOpacity: 0.15,
                weight: 2,
                dashArray: '8, 8'
            }).addTo(map);
            
            // สร้าง center marker
            const centerMarker = L.marker(center, {
                icon: L.divIcon({
                    className: 'radius-center-marker',
                    html: '<div style="background: #0ea5e9; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            const index = radiusCircles.length;
            
            // สร้าง delete button marker
            const deleteMarker = createDeleteMarker(center, index);
            
            // สร้าง resize handle
            const resizeHandle = createResizeHandle(center, radius, index);
            
            // Add to array
            radiusCircles.push({
                circle: circle,
                centerMarker: centerMarker,
                deleteMarker: deleteMarker,
                resizeHandle: resizeHandle,
                center: center,
                radius: radius
            });
            
            // Click events to select
            circle.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                highlightCircle(radiusCircles.indexOf(radiusCircles.find(item => item.circle === circle)));
            });
            centerMarker.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                const idx = radiusCircles.findIndex(item => item.centerMarker === centerMarker);
                highlightCircle(idx);
            });
            
            document.getElementById('radiusInfo').innerHTML = '✓ สร้างวงกลมแล้ว - ลาก ○ เพื่อปรับขนาด, กด ✕ เพื่อลบ';
            updateRadiusInfo(radius);
        }
        
        function createDeleteMarker(center, index) {
            const deleteIcon = L.divIcon({
                className: 'delete-marker-wrapper',
                html: '<div style="background: #ef4444; width: 22px; height: 22px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; color: white; font-weight: bold;">✕</div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });
            
            // Position delete marker at top-left of center
            const deletePos = calculatePointAtDistance(center.lat, center.lng, 50, 315); // 315° = NW
            
            const marker = L.marker([deletePos.lat, deletePos.lng], {
                icon: deleteIcon,
                zIndexOffset: 2000
            }).addTo(map);
            
            marker.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                const idx = radiusCircles.findIndex(item => item.deleteMarker === marker);
                if (idx !== -1) {
                    deleteCircleByIndex(idx);
                }
            });
            
            return marker;
        }
        
        function createResizeHandle(center, radius, index) {
            const handleIcon = L.divIcon({
                className: 'resize-handle-wrapper',
                html: '<div style="background: white; width: 16px; height: 16px; border-radius: 50%; border: 3px solid #0ea5e9; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: nwse-resize;"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            // Calculate edge point (east side)
            const edgePoint = calculatePointAtDistance(center.lat, center.lng, radius, 90);
            
            const handle = L.marker([edgePoint.lat, edgePoint.lng], {
                icon: handleIcon,
                draggable: true,
                zIndexOffset: 1500
            }).addTo(map);
            
            // Handle drag events
            handle.on('dragstart', function() {
                isResizing = true;
                const idx = radiusCircles.findIndex(item => item.resizeHandle === handle);
                resizingCircleIndex = idx;
                map.dragging.disable();
            });
            
            handle.on('drag', function(e) {
                const idx = radiusCircles.findIndex(item => item.resizeHandle === handle);
                if (idx === -1) return;
                
                const item = radiusCircles[idx];
                const handlePos = e.target.getLatLng();
                const newRadius = calculateDistance(item.center.lat, item.center.lng, handlePos.lat, handlePos.lng) * 1000;
                
                // Minimum radius 10 meters
                if (newRadius >= 10) {
                    item.circle.setRadius(newRadius);
                    item.radius = newRadius;
                    updateRadiusInfo(newRadius);
                }
            });
            
            handle.on('dragend', function(e) {
                isResizing = false;
                resizingCircleIndex = null;
                map.dragging.enable();
                
                // Update handle position to exact edge
                const idx = radiusCircles.findIndex(item => item.resizeHandle === handle);
                if (idx !== -1) {
                    const item = radiusCircles[idx];
                    const newEdge = calculatePointAtDistance(item.center.lat, item.center.lng, item.radius, 90);
                    handle.setLatLng([newEdge.lat, newEdge.lng]);
                }
            });
            
            return handle;
        }
        
        function highlightCircle(index) {
            if (index === -1 || !radiusCircles[index]) return;
            
            // Reset all circles
            radiusCircles.forEach((item) => {
                item.circle.setStyle({
                    dashArray: '8, 8',
                    weight: 2
                });
            });
            
            // Highlight selected
            radiusCircles[index].circle.setStyle({
                dashArray: null,
                weight: 3
            });
            
            selectedCircleIndex = index;
            updateRadiusInfo(radiusCircles[index].radius);
        }
        
        function deleteCircleByIndex(index) {
            if (index === -1 || !radiusCircles[index]) return;
            
            const item = radiusCircles[index];
            map.removeLayer(item.circle);
            map.removeLayer(item.centerMarker);
            map.removeLayer(item.deleteMarker);
            if (item.resizeHandle) {
                map.removeLayer(item.resizeHandle);
            }
            
            radiusCircles.splice(index, 1);
            
            if (selectedCircleIndex === index) {
                selectedCircleIndex = null;
            }
            
            if (radiusMode) {
                if (radiusCircles.length === 0) {
                    document.getElementById('radiusInfo').innerHTML = '<i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม';
                    document.getElementById('radiusValue').innerHTML = '0 <span>เมตร</span>';
                } else {
                    document.getElementById('radiusInfo').innerHTML = `มี ${radiusCircles.length} วงกลม - วาดเพิ่มหรือลาก ○ เพื่อปรับขนาด`;
                }
            }
        }
        
        // Mouse events for drag-to-draw
        document.getElementById('map').addEventListener('mousedown', function(e) {
            if (!radiusMode || isResizing) return;
            
            // ตรวจสอบว่าคลิกที่ marker (resize handle, delete marker, center marker) หรือไม่
            // ถ้าคลิกที่ marker ให้ไม่สร้างวงกลมใหม่
            if (e.target.closest('.resize-handle-wrapper') || 
                e.target.closest('.delete-marker-wrapper') ||
                e.target.closest('.radius-center-marker') ||
                e.target.closest('.leaflet-marker-icon')) {
                return;
            }
            
            // Get map container position
            const rect = document.getElementById('map').getBoundingClientRect();
            const containerPoint = L.point(e.clientX - rect.left, e.clientY - rect.top);
            const latlng = map.containerPointToLatLng(containerPoint);
            
            isDrawing = true;
            drawStartPoint = latlng;
            map.dragging.disable();
            
            // Create preview circle
            currentDrawCircle = L.circle(latlng, {
                radius: 0,
                color: '#0ea5e9',
                fillColor: '#0ea5e9',
                fillOpacity: 0.2,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
        });
        
        document.getElementById('map').addEventListener('mousemove', function(e) {
            if (!isDrawing || !drawStartPoint || !currentDrawCircle) return;
            
            const rect = document.getElementById('map').getBoundingClientRect();
            const containerPoint = L.point(e.clientX - rect.left, e.clientY - rect.top);
            const latlng = map.containerPointToLatLng(containerPoint);
            
            const radius = calculateDistance(drawStartPoint.lat, drawStartPoint.lng, latlng.lat, latlng.lng) * 1000;
            currentDrawCircle.setRadius(radius);
            updateRadiusInfo(radius);
        });
        
        document.getElementById('map').addEventListener('mouseup', function(e) {
            if (!isDrawing || !drawStartPoint) return;
            
            const rect = document.getElementById('map').getBoundingClientRect();
            const containerPoint = L.point(e.clientX - rect.left, e.clientY - rect.top);
            const latlng = map.containerPointToLatLng(containerPoint);
            
            const radius = calculateDistance(drawStartPoint.lat, drawStartPoint.lng, latlng.lat, latlng.lng) * 1000;
            
            // Remove preview
            if (currentDrawCircle) {
                map.removeLayer(currentDrawCircle);
                currentDrawCircle = null;
            }
            
            // Only create if radius > 10 meters (prevent accidental clicks)
            if (radius > 10) {
                finalizeCircle(drawStartPoint, radius);
            }
            
            isDrawing = false;
            drawStartPoint = null;
            map.dragging.enable();
        });
        
        // Handle mouse leaving map
        document.getElementById('map').addEventListener('mouseleave', function() {
            if (isDrawing && currentDrawCircle) {
                map.removeLayer(currentDrawCircle);
                currentDrawCircle = null;
                isDrawing = false;
                drawStartPoint = null;
                map.dragging.enable();
            }
        });

        // Calculate distance using Haversine formula
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calculate total distance for all points
        function calculateTotalDistance() {
            let total = 0;
            for (let i = 1; i < measurePoints.length; i++) {
                total += calculateDistance(
                    measurePoints[i-1].lat, measurePoints[i-1].lng,
                    measurePoints[i].lat, measurePoints[i].lng
                );
            }
            return total;
        }

        // Update the polyline with all points
        function updateMeasureLine() {
            if (measureLine) {
                map.removeLayer(measureLine);
            }
            if (measurePoints.length >= 2) {
                measureLine = L.polyline(measurePoints, {
                    color: '#ef4444',
                    weight: 3,
                    dashArray: '10, 10'
                }).addTo(map);
            }
        }

        // Map click handler for distance measurement
        map.on('click', function(e) {
            if (measureMode) {
                // Distance measurement mode
                // Create marker with point number
                const pointNum = measurePoints.length + 1;
                const pointIcon = L.divIcon({
                    className: 'measure-point',
                    html: `<div style="background: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold;">${pointNum}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                const marker = L.marker(e.latlng, { icon: pointIcon }).addTo(map);
                measureMarkers.push(marker);
                measurePoints.push(e.latlng);
            
            // Update the line
            updateMeasureLine();
            
            // Calculate and show total distance
            totalDistance = calculateTotalDistance();
            
            if (measurePoints.length === 1) {
                document.getElementById('distanceValue').innerHTML = '0.00 <span>กม.</span>';
            } else {
                // Show distance appropriately
                if (totalDistance < 1) {
                    // Show in meters if less than 1 km
                    document.getElementById('distanceValue').innerHTML = `${(totalDistance * 1000).toFixed(0)} <span>เมตร</span>`;
                } else {
                    document.getElementById('distanceValue').innerHTML = `${totalDistance.toFixed(2)} <span>กม.</span>`;
                }
            }
            }
        });

        // -------------------------
        // Map View Measurement Tool
        // -------------------------
        let measureModeFull = false;
        let measurePointsFull = [];
        let measureMarkersFull = [];
        let measureLineFull = null;

        function toggleMeasureFull() {
            measureModeFull = !measureModeFull;
            const btn = document.getElementById('measureBtnFull');
            const panel = document.getElementById('distancePanelFull');
            
            if (measureModeFull) {
                // ปิด radius mode ถ้าเปิดอยู่
                if (radiusModeFull) {
                    toggleRadiusFull();
                }
                
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> ยกเลิก';
                panel.classList.add('active');
                document.getElementById('distanceInfoFull').innerHTML = 'คลิกเพื่อเพิ่มจุด <button onclick="clearMeasurementFull()" style="background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; margin-left: 8px;"><i class="fas fa-trash"></i> ล้าง</button>';
                document.getElementById('distanceValueFull').innerHTML = '0.00 <span>กม.</span>';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-ruler"></i> วัดระยะ';
                panel.classList.remove('active');
                clearMeasurementFull();
            }
        }

        function clearMeasurementFull() {
            measurePointsFull = [];
            measureMarkersFull.forEach(m => mapView.removeLayer(m));
            measureMarkersFull = [];
            if (measureLineFull) {
                mapView.removeLayer(measureLineFull);
                measureLineFull = null;
            }
            if (measureModeFull) {
                document.getElementById('distanceValueFull').innerHTML = '0.00 <span>กม.</span>';
            }
        }

        function calculateTotalDistanceFull() {
            let total = 0;
            for (let i = 1; i < measurePointsFull.length; i++) {
                total += calculateDistance(
                    measurePointsFull[i-1].lat, measurePointsFull[i-1].lng,
                    measurePointsFull[i].lat, measurePointsFull[i].lng
                );
            }
            return total;
        }

        function updateMeasureLineFull() {
            if (measureLineFull) {
                mapView.removeLayer(measureLineFull);
            }
            if (measurePointsFull.length >= 2) {
                measureLineFull = L.polyline(measurePointsFull, {
                    color: '#ef4444',
                    weight: 3,
                    dashArray: '10, 10'
                }).addTo(mapView);
            }
        }

        // -------------------------
        // Map View Radius Tool
        // -------------------------
        let radiusModeFull = false;
        let radiusCirclesFull = [];
        let isDrawingFull = false;
        let drawStartPointFull = null;
        let currentDrawCircleFull = null;
        let isResizingFull = false;

        function toggleRadiusFull() {
            radiusModeFull = !radiusModeFull;
            const btn = document.getElementById('radiusBtnFull');
            const panel = document.getElementById('radiusPanelFull');
            
            if (radiusModeFull) {
                // ปิด measure mode ถ้าเปิดอยู่
                if (measureModeFull) {
                    toggleMeasureFull();
                }
                
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> ยกเลิก';
                panel.classList.add('active');
                
                document.getElementById('radiusInfoFull').innerHTML = '<i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม';
                document.getElementById('radiusValueFull').innerHTML = '0 <span>เมตร</span>';
                
                document.getElementById('map-view').style.cursor = 'crosshair';
                mapView.dragging.enable();
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-circle"></i> วัดรัศมี';
                panel.classList.remove('active');
                
                document.getElementById('map-view').style.cursor = '';
                mapView.dragging.enable();
            }
        }

        function clearRadiusFull() {
            radiusCirclesFull.forEach(item => {
                mapView.removeLayer(item.circle);
                mapView.removeLayer(item.centerMarker);
                if (item.deleteMarker) {
                    mapView.removeLayer(item.deleteMarker);
                }
                if (item.resizeHandle) {
                    mapView.removeLayer(item.resizeHandle);
                }
            });
            radiusCirclesFull = [];
            
            if (currentDrawCircleFull) {
                mapView.removeLayer(currentDrawCircleFull);
                currentDrawCircleFull = null;
            }
            
            if (radiusModeFull) {
                document.getElementById('radiusInfoFull').innerHTML = '<i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม';
                document.getElementById('radiusValueFull').innerHTML = '0 <span>เมตร</span>';
            }
        }

        function updateRadiusInfoFull(radiusMeters) {
            const km = radiusMeters / 1000;
            if (km < 1) {
                document.getElementById('radiusValueFull').innerHTML = `${Math.round(radiusMeters)} <span>เมตร</span>`;
            } else {
                document.getElementById('radiusValueFull').innerHTML = `${km.toFixed(2)} <span>กม.</span>`;
            }
        }

        function finalizeCircleFull(center, radius) {
            const circle = L.circle(center, {
                radius: radius,
                color: '#0ea5e9',
                fillColor: '#0ea5e9',
                fillOpacity: 0.15,
                weight: 2,
                dashArray: '8, 8'
            }).addTo(mapView);
            
            const centerMarker = L.marker(center, {
                icon: L.divIcon({
                    className: 'radius-center-marker',
                    html: '<div style="background: #0ea5e9; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(mapView);
            
            const index = radiusCirclesFull.length;
            
            const deleteMarker = createDeleteMarkerFull(center, index);
            const resizeHandle = createResizeHandleFull(center, radius, index);
            
            radiusCirclesFull.push({
                circle: circle,
                centerMarker: centerMarker,
                deleteMarker: deleteMarker,
                resizeHandle: resizeHandle,
                center: center,
                radius: radius
            });
            
            document.getElementById('radiusInfoFull').innerHTML = '✓ สร้างวงกลมแล้ว - ลาก ○ เพื่อปรับขนาด, กด ✕ เพื่อลบ';
            updateRadiusInfoFull(radius);
        }

        function createDeleteMarkerFull(center, index) {
            const deleteIcon = L.divIcon({
                className: 'delete-marker-wrapper',
                html: '<div style="background: #ef4444; width: 22px; height: 22px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; color: white; font-weight: bold;">✕</div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });
            
            const deletePos = calculatePointAtDistance(center.lat, center.lng, 50, 315);
            
            const marker = L.marker([deletePos.lat, deletePos.lng], {
                icon: deleteIcon,
                zIndexOffset: 2000
            }).addTo(mapView);
            
            marker.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                const idx = radiusCirclesFull.findIndex(item => item.deleteMarker === marker);
                if (idx !== -1) {
                    deleteCircleByIndexFull(idx);
                }
            });
            
            return marker;
        }

        function createResizeHandleFull(center, radius, index) {
            const handleIcon = L.divIcon({
                className: 'resize-handle-wrapper',
                html: '<div style="background: white; width: 16px; height: 16px; border-radius: 50%; border: 3px solid #0ea5e9; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: nwse-resize;"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const edgePoint = calculatePointAtDistance(center.lat, center.lng, radius, 90);
            
            const handle = L.marker([edgePoint.lat, edgePoint.lng], {
                icon: handleIcon,
                draggable: true,
                zIndexOffset: 1500
            }).addTo(mapView);
            
            handle.on('dragstart', function() {
                isResizingFull = true;
                mapView.dragging.disable();
            });
            
            handle.on('drag', function(e) {
                const idx = radiusCirclesFull.findIndex(item => item.resizeHandle === handle);
                if (idx === -1) return;
                
                const item = radiusCirclesFull[idx];
                const handlePos = e.target.getLatLng();
                const newRadius = calculateDistance(item.center.lat, item.center.lng, handlePos.lat, handlePos.lng) * 1000;
                
                if (newRadius >= 10) {
                    item.circle.setRadius(newRadius);
                    item.radius = newRadius;
                    updateRadiusInfoFull(newRadius);
                }
            });
            
            handle.on('dragend', function(e) {
                isResizingFull = false;
                mapView.dragging.enable();
                
                const idx = radiusCirclesFull.findIndex(item => item.resizeHandle === handle);
                if (idx !== -1) {
                    const item = radiusCirclesFull[idx];
                    const newEdge = calculatePointAtDistance(item.center.lat, item.center.lng, item.radius, 90);
                    handle.setLatLng([newEdge.lat, newEdge.lng]);
                }
            });
            
            return handle;
        }

        function deleteCircleByIndexFull(index) {
            if (index === -1 || !radiusCirclesFull[index]) return;
            
            const item = radiusCirclesFull[index];
            mapView.removeLayer(item.circle);
            mapView.removeLayer(item.centerMarker);
            mapView.removeLayer(item.deleteMarker);
            if (item.resizeHandle) {
                mapView.removeLayer(item.resizeHandle);
            }
            
            radiusCirclesFull.splice(index, 1);
            
            if (radiusModeFull) {
                if (radiusCirclesFull.length === 0) {
                    document.getElementById('radiusInfoFull').innerHTML = '<i class="fas fa-mouse-pointer"></i> คลิกค้าง + ลากเพื่อวาดวงกลม';
                    document.getElementById('radiusValueFull').innerHTML = '0 <span>เมตร</span>';
                } else {
                    document.getElementById('radiusInfoFull').innerHTML = `มี ${radiusCirclesFull.length} วงกลม - วาดเพิ่มหรือลาก ○ เพื่อปรับขนาด`;
                }
            }
        }

        // Mouse events for Map View drag-to-draw
        document.getElementById('map-view').addEventListener('mousedown', function(e) {
            if (!radiusModeFull || isResizingFull) return;
            if (!mapView) return;
            
            if (e.target.closest('.resize-handle-wrapper') || 
                e.target.closest('.delete-marker-wrapper') ||
                e.target.closest('.radius-center-marker') ||
                e.target.closest('.leaflet-marker-icon')) {
                return;
            }
            
            const rect = document.getElementById('map-view').getBoundingClientRect();
            const containerPoint = L.point(e.clientX - rect.left, e.clientY - rect.top);
            const latlng = mapView.containerPointToLatLng(containerPoint);
            
            isDrawingFull = true;
            drawStartPointFull = latlng;
            mapView.dragging.disable();
            
            currentDrawCircleFull = L.circle(latlng, {
                radius: 0,
                color: '#0ea5e9',
                fillColor: '#0ea5e9',
                fillOpacity: 0.2,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(mapView);
        });

        document.getElementById('map-view').addEventListener('mousemove', function(e) {
            if (!isDrawingFull || !drawStartPointFull || !currentDrawCircleFull) return;
            if (!mapView) return;
            
            const rect = document.getElementById('map-view').getBoundingClientRect();
            const containerPoint = L.point(e.clientX - rect.left, e.clientY - rect.top);
            const latlng = mapView.containerPointToLatLng(containerPoint);
            
            const radius = calculateDistance(drawStartPointFull.lat, drawStartPointFull.lng, latlng.lat, latlng.lng) * 1000;
            currentDrawCircleFull.setRadius(radius);
            updateRadiusInfoFull(radius);
        });

        document.getElementById('map-view').addEventListener('mouseup', function(e) {
            if (!isDrawingFull || !drawStartPointFull) return;
            if (!mapView) return;
            
            const rect = document.getElementById('map-view').getBoundingClientRect();
            const containerPoint = L.point(e.clientX - rect.left, e.clientY - rect.top);
            const latlng = mapView.containerPointToLatLng(containerPoint);
            
            const radius = calculateDistance(drawStartPointFull.lat, drawStartPointFull.lng, latlng.lat, latlng.lng) * 1000;
            
            if (currentDrawCircleFull) {
                mapView.removeLayer(currentDrawCircleFull);
                currentDrawCircleFull = null;
            }
            
            if (radius > 10) {
                finalizeCircleFull(drawStartPointFull, radius);
            }
            
            isDrawingFull = false;
            drawStartPointFull = null;
            mapView.dragging.enable();
        });

        document.getElementById('map-view').addEventListener('mouseleave', function() {
            if (isDrawingFull && currentDrawCircleFull && mapView) {
                mapView.removeLayer(currentDrawCircleFull);
                currentDrawCircleFull = null;
                isDrawingFull = false;
                drawStartPointFull = null;
                mapView.dragging.enable();
            }
        });
    </script>
    <script>
        // Excel Export Functionality (dark mode removed)
        function exportToExcel(type) {
            // For real Excel export, we use SheetJS library approach
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Thai support
            let filename = "export_data.csv";

            if (type === 'recent-checkins') {
                csvContent += "ทีม,ชื่อ,สถานที่,เวลา\n";
                const items = document.querySelectorAll('.checkins-list .checkin-item');
                items.forEach(item => {
                   const team = item.querySelector('.team-badge').innerText;
                   const name = item.querySelector('.name').innerText;
                   const loc = item.querySelector('.location').innerText.replace(',', ' ').replace(/\s+/g, ' ').trim();
                   const time = item.querySelector('.time').innerText.replace(/\s+/g, ' ').trim();
                   csvContent += `"${team}","${name}","${loc}","${time}"\n`;
                });
                filename = "recent_checkins_" + formatDateForFilename() + ".csv";
            } else if (type === 'full-data') {
                csvContent += "ทีม,ลูกค้า,สถานที่,พิกัด,เวลา,สถานะ\n";
                let targetRows = document.querySelectorAll('#page-dashboard .data-table tbody tr');
                if(document.getElementById('page-checkins').style.display !== 'none') {
                    targetRows = document.querySelectorAll('#page-checkins .data-table tbody tr');
                }

                targetRows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const team = cols[0].innerText.trim();
                    const name = cols[1].innerText.replace('\n', ' ').trim();
                    const loc = cols[2].innerText.replace(',', ' ').trim();
                    const coord = cols[3] ? cols[3].innerText.trim() : '';
                    const time = cols[4] ? cols[4].innerText.trim() : '';
                    const status = cols[5] ? cols[5].innerText.trim() : '';
                    
                    csvContent += `"${team}","${name}","${loc}","${coord}","${time}","${status}"\n`;
                });
                filename = "checkin_data_" + formatDateForFilename() + ".csv";
            } else if (type === 'team-performance') {
                csvContent += "ทีม,จำนวน Check-ins,อัตราสำเร็จ\n";
                csvContent += '"A","245","98.5%"\n';
                csvContent += '"B","231","97.8%"\n';
                csvContent += '"C","218","96.5%"\n';
                csvContent += '"D","205","95.2%"\n';
                csvContent += '"E","198","94.8%"\n';
                csvContent += '"F","185","93.5%"\n';
                csvContent += '"G","172","92.1%"\n';
                csvContent += '"H","156","91.0%"\n';
                filename = "team_performance_" + formatDateForFilename() + ".csv";
            }

            downloadFile(csvContent, filename);
            showExportNotification('CSV', filename);
            closeAllExportMenus();
        }

        function exportToCSV(type) {
            exportToExcel(type); // Same as Excel for CSV
        }

        function exportToPDF() {
            // Mock PDF export - in real implementation, use jsPDF or similar
            alert('กำลังสร้างไฟล์ PDF...\n\nหมายเหตุ: ฟีเจอร์นี้ต้องเชื่อมต่อ Backend เพื่อสร้าง PDF จริง');
            closeAllExportMenus();
        }

        function downloadFile(content, filename) {
            const encodedUri = encodeURI(content);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatDateForFilename() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function showExportNotification(type, filename) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                z-index: 10000;
                font-family: 'Prompt', sans-serif;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ส่งออก ${type} สำเร็จ: ${filename}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Export Dropdown Toggle
        function toggleExportMenu(type) {
            closeAllExportMenus();
            const menu = document.getElementById('exportMenu' + type.charAt(0).toUpperCase() + type.slice(1));
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function closeAllExportMenus() {
            document.querySelectorAll('.export-menu').forEach(menu => {
                menu.classList.remove('active');
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.export-dropdown')) {
                closeAllExportMenus();
            }
        });

        // ===========================
        // Photo Gallery Functions
        // ===========================
        // galleryImages จะถูก populate จาก firestoreCheckins
        let galleryImages = [];
        let galleryAlbums = []; // อัลบั้มแยกตาม check-in
        
        // อัพเดท Gallery จาก Firestore - แบบอัลบั้ม
        function updatePhotoGallery() {
            const galleryGrid = document.getElementById('galleryGrid');
            if (!galleryGrid) return;
            
            // สร้าง gallery images และ albums จาก Firestore data
            galleryImages = [];
            galleryAlbums = [];
            
            firestoreCheckins.forEach((item, index) => {
                const albumPhotos = [];
                
                if (item.houseFrontUrl) {
                    const photo = {
                        src: item.houseFrontUrl,
                        name: item.customerName || '-',
                        team: item.team || 'A',
                        type: 'หน้าบ้าน',
                        time: item.checkinTime.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
                        date: item.checkinTime.toLocaleDateString('th-TH'),
                        contract: item.contractNumber || '-',
                        branch: item.branch || '-',
                        checkinId: item.id
                    };
                    galleryImages.push(photo);
                    albumPhotos.push(photo);
                }
                if (item.contractPhotoUrl) {
                    const photo = {
                        src: item.contractPhotoUrl,
                        name: item.customerName || '-',
                        team: item.team || 'A',
                        type: 'สัญญา',
                        time: item.checkinTime.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
                        date: item.checkinTime.toLocaleDateString('th-TH'),
                        contract: item.contractNumber || '-',
                        branch: item.branch || '-',
                        checkinId: item.id
                    };
                    galleryImages.push(photo);
                    albumPhotos.push(photo);
                }
                
                if (albumPhotos.length > 0) {
                    galleryAlbums.push({
                        id: item.id,
                        customerName: item.customerName || '-',
                        team: item.team || 'A',
                        branch: item.branch || '-',
                        contract: item.contractNumber || '-',
                        time: item.checkinTime.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
                        date: item.checkinTime.toLocaleDateString('th-TH'),
                        photos: albumPhotos,
                        coverPhoto: albumPhotos[0].src,
                        photoCount: albumPhotos.length
                    });
                }
            });
            
            if (galleryAlbums.length === 0) {
                galleryGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 40px; color: var(--text-secondary);">
                        <i class="fas fa-images fa-3x" style="margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>ยังไม่มีรูปภาพใน Gallery</p>
                        <small>รูปภาพจะแสดงเมื่อมีการ Check-in</small>
                    </div>
                `;
                return;
            }
            
            // แสดงแบบอัลบั้ม (group by check-in)
            galleryGrid.innerHTML = galleryAlbums.map((album, albumIndex) => `
                <div class="gallery-album" onclick="openAlbumViewer(${albumIndex})">
                    <div class="album-cover">
                        <img src="${album.coverPhoto}" alt="${album.customerName}">
                        ${album.photoCount > 1 ? `<div class="photo-count"><i class="fas fa-images"></i> ${album.photoCount}</div>` : ''}
                    </div>
                    <div class="album-info">
                        <div class="album-name">${album.customerName}</div>
                        <div class="album-meta">
                            <span class="team-badge team-badge-sm team-${album.team.toLowerCase()}" style="width: 18px; height: 18px; font-size: 0.6rem;">${album.team}</span>
                            ${album.branch} • ${album.time}
                        </div>
                        <div class="album-contract">${album.contract}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // เปิดอัลบั้ม
        function openAlbumViewer(albumIndex) {
            const album = galleryAlbums[albumIndex];
            if (!album) return;
            
            // หา index แรกของรูปในอัลบั้มนี้
            const firstPhotoIndex = galleryImages.findIndex(img => img.checkinId === album.id);
            if (firstPhotoIndex >= 0) {
                openImageViewer(firstPhotoIndex);
            }
        }

        let currentImageIndex = 0;

        function openImageViewer(index) {
            currentImageIndex = index;
            const img = galleryImages[index];
            
            // Create viewer if not exists
            let viewer = document.getElementById('imageViewer');
            if (!viewer) {
                viewer = document.createElement('div');
                viewer.id = 'imageViewer';
                viewer.className = 'image-viewer';
                viewer.innerHTML = `
                    <button class="viewer-close" onclick="closeImageViewer()"><i class="fas fa-times"></i></button>
                    <div class="viewer-counter" id="viewerCounter">1 / 1</div>
                    <button class="viewer-nav prev" onclick="prevImage()"><i class="fas fa-chevron-left"></i></button>
                    <img id="viewerImage" src="" alt="">
                    <button class="viewer-nav next" onclick="nextImage()"><i class="fas fa-chevron-right"></i></button>
                    <div class="viewer-info">
                        <h3 id="viewerName" style="margin: 0 0 8px 0; font-size: 1.1rem;"></h3>
                        <p id="viewerMeta" style="margin: 0; opacity: 0.9; font-size: 0.9rem;"></p>
                    </div>
                `;
                document.body.appendChild(viewer);
                
                // Close on click outside
                viewer.addEventListener('click', (e) => {
                    if (e.target === viewer) closeImageViewer();
                });
                
                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    const v = document.getElementById('imageViewer');
                    if (!v || !v.classList.contains('active')) return;
                    if (e.key === 'Escape') closeImageViewer();
                    if (e.key === 'ArrowRight') nextImage();
                    if (e.key === 'ArrowLeft') prevImage();
                });
            }
            
            document.getElementById('viewerImage').src = img.src;
            document.getElementById('viewerName').textContent = img.name;
            document.getElementById('viewerCounter').textContent = `${index + 1} / ${galleryImages.length}`;
            document.getElementById('viewerMeta').innerHTML = `
                <span class="team-badge team-badge-sm team-${img.team.toLowerCase()}" style="width: 20px; height: 20px; font-size: 0.7rem; display: inline-flex;">${img.team}</span>
                ${img.type} • ${img.time} • สัญญา: ${img.contract}
            `;
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            if (viewer) {
                viewer.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
            openImageViewer(currentImageIndex);
        }

        function prevImage() {
            currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
            openImageViewer(currentImageIndex);
        }

        function filterGallery() {
            const team = document.getElementById('galleryTeamFilter').value;
            const type = document.getElementById('galleryTypeFilter').value;
            // In real implementation, this would filter and reload the gallery
        }

        // Keyboard navigation for image viewer
        document.addEventListener('keydown', function(e) {
            const viewer = document.getElementById('imageViewer');
            if (viewer && viewer.classList.contains('active')) {
                if (e.key === 'Escape') closeImageViewer();
                if (e.key === 'ArrowRight') nextImage();
                if (e.key === 'ArrowLeft') prevImage();
            }
        });

        // ===========================
        // Real-time Updates System
        // ===========================
        let realtimeInterval = null;
        let lastUpdateTime = new Date();

        function startRealtime() {
            if (realtimeInterval) return;
            
            // Real-time updates มาจาก Firestore listener แล้ว
            // ไม่ต้อง simulate อีก
            realtimeInterval = setInterval(() => {
                updateRealtimeBadge();
            }, 30000); // Check every 30 seconds
        }

        function stopRealtime() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        function updateRealtimeBadge() {
            const badge = document.getElementById('realtimeBadge');
            if (badge) {
                const now = new Date();
                const diff = Math.floor((now - lastUpdateTime) / 1000);
                if (diff < 60) {
                    badge.innerHTML = '<span class="realtime-dot"></span><span>Live</span>';
                } else {
                    badge.innerHTML = `<span class="realtime-dot" style="background: #f59e0b;"></span><span>${Math.floor(diff/60)}m ago</span>`;
                }
            }
        }

        // Global Search Handler
        function handleGlobalSearch(query) {
            if (query.length < 2) return;
            // In real implementation, this would filter data across all tables
        }

        // Start real-time badge on page load
        startRealtime();

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100px); opacity: 0; }
            }
            @keyframes slideInRight {
                from { transform: translateX(100px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
