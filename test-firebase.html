<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Test | Bait Check-In</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #0f172a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h1 i { color: #f59e0b; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .card h2 {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            font-family: 'Prompt', sans-serif;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin: 4px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log .success { color: #4ade80; }
        .log .error { color: #f87171; }
        .log .info { color: #60a5fa; }
        .log .warning { color: #fbbf24; }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 6px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Prompt', sans-serif;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #0ea5e9;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .result-table th, .result-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .result-table th {
            background: #f8fafc;
            font-weight: 500;
            color: #64748b;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-fire"></i> Firebase Connection Test</h1>
        
        <!-- Connection Status -->
        <div class="card">
            <h2><i class="fas fa-plug"></i> สถานะการเชื่อมต่อ</h2>
            <div id="connectionStatus" class="status pending">
                <i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบ...
            </div>
        </div>
        
        <!-- Test Actions -->
        <div class="card">
            <h2><i class="fas fa-vial"></i> ทดสอบ Firebase</h2>
            <button class="btn btn-primary" onclick="testFirestoreWrite()">
                <i class="fas fa-database"></i> ทดสอบ Write Firestore
            </button>
            <button class="btn btn-success" onclick="testFirestoreRead()">
                <i class="fas fa-download"></i> ทดสอบ Read Firestore
            </button>
            <button class="btn btn-warning" onclick="testStorageUpload()">
                <i class="fas fa-cloud-upload-alt"></i> ทดสอบ Upload Storage
            </button>
            <button class="btn btn-danger" onclick="clearLog()">
                <i class="fas fa-trash"></i> ล้าง Log
            </button>
        </div>
        
        <!-- Test Checkin Form -->
        <div class="card">
            <h2><i class="fas fa-map-marker-alt"></i> ทดสอบสร้าง Check-in</h2>
            <div class="form-group">
                <label>ชื่อลูกค้า</label>
                <input type="text" id="testCustomerName" value="ทดสอบ Firebase">
            </div>
            <div class="form-group">
                <label>เลขที่สัญญา</label>
                <input type="text" id="testContractNumber" value="TEST-001">
            </div>
            <div class="form-group">
                <label>ทีม</label>
                <select id="testTeam">
                    <option value="A">Team A</option>
                    <option value="B">Team B</option>
                    <option value="C">Team C</option>
                    <option value="Z">Team Z</option>
                </select>
            </div>
            <div class="form-group">
                <label>สาขา</label>
                <select id="testBranch">
                    <option value="พุทธมณฑล">พุทธมณฑล (เขต 1)</option>
                    <option value="สาทร">สาทร (เขต 2)</option>
                    <option value="ลาดพร้าว">ลาดพร้าว (เขต 4)</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="testCreateCheckin()">
                <i class="fas fa-paper-plane"></i> สร้าง Test Check-in
            </button>
        </div>
        
        <!-- Results Table -->
        <div class="card">
            <h2><i class="fas fa-list"></i> ข้อมูล Check-ins ล่าสุด</h2>
            <button class="btn btn-success" onclick="loadLatestCheckins()" style="margin-bottom: 16px;">
                <i class="fas fa-sync"></i> โหลดข้อมูล
            </button>
            <div id="checkinsTable"></div>
        </div>
        
        <!-- Log Output -->
        <div class="card">
            <h2><i class="fas fa-terminal"></i> Console Log</h2>
            <div id="logOutput" class="log">[System] Firebase Test Page Loaded...\n</div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCDvOxdpMIQoadHlod90EtQgpEU4tDcHUY",
            authDomain: "bait-check-in-webapp.firebaseapp.com",
            projectId: "bait-check-in-webapp",
            storageBucket: "bait-check-in-webapp.firebasestorage.app",
            messagingSenderId: "850336159440",
            appId: "1:850336159440:web:c104204bd3f2d18b5b70d5",
            measurementId: "G-V52G8M5H6Z"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Logging function
        function log(message, type = 'info') {
            const logEl = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const colorClass = type;
            logEl.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '[System] Log cleared.\n';
        }
        
        // Test Connection
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                // ลองอ่านจาก Firestore ก่อน (read-only test)
                log('Testing Firebase connection...', 'info');
                log(`Project ID: ${firebaseConfig.projectId}`, 'info');
                
                // ทดสอบอ่าน checkins collection
                const snapshot = await db.collection('checkins').limit(1).get();
                
                statusEl.className = 'status success';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> เชื่อมต่อ Firebase สำเร็จ!';
                log('Firebase connection successful!', 'success');
                log(`Storage Bucket: ${firebaseConfig.storageBucket}`, 'info');
                log(`Found ${snapshot.size} document(s) in checkins`, 'info');
            } catch (error) {
                // ถ้า error เป็น permission denied แสดงคำแนะนำ
                if (error.message.includes('permission') || error.code === 'permission-denied') {
                    statusEl.className = 'status error';
                    statusEl.innerHTML = `
                        <div>
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>ต้องอัพเดท Security Rules ใน Firebase Console</strong>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85rem;">
                            1. ไปที่ <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules" target="_blank" style="color: #0ea5e9;">Firebase Console > Firestore > Rules</a><br>
                            2. คัดลอก Rules จากไฟล์ <code>firebase/firestore.rules</code><br>
                            3. กด Publish แล้วรอ 1-2 นาที<br>
                            4. กลับมากดปุ่ม "ทดสอบ" อีกครั้ง
                        </div>
                    `;
                    log('Permission denied - Security Rules ยังไม่ได้อัพเดท', 'error');
                    log('กรุณาไปที่ Firebase Console > Firestore > Rules', 'warning');
                    showRulesGuide();
                } else {
                    statusEl.className = 'status error';
                    statusEl.innerHTML = `<i class="fas fa-times-circle"></i> เชื่อมต่อล้มเหลว: ${error.message}`;
                    log('Connection failed: ' + error.message, 'error');
                }
            }
        }
        
        // แสดง Rules ที่ต้อง copy
        function showRulesGuide() {
            const rulesCode = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`;
            log('--- คัดลอก Rules นี้ไปวางใน Firebase Console ---', 'warning');
            log(rulesCode, 'info');
            log('--- สิ้นสุด Rules ---', 'warning');
        }
        
        // Test Firestore Write
        async function testFirestoreWrite() {
            log('Testing Firestore write...', 'info');
            try {
                const docRef = await db.collection('checkins').add({
                    team: 'TEST',
                    customerName: 'Test Write ' + new Date().toISOString(),
                    contractNumber: 'TEST-WRITE',
                    branch: 'ทดสอบ',
                    zone: 'เขต 1',
                    location: { lat: 13.74, lng: 100.54, address: 'Test', accuracy: 10 },
                    photos: { houseFront: null, contractPhoto: null },
                    notes: 'Test write - will be deleted',
                    visible: false,
                    checkinTime: firebase.firestore.Timestamp.now(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                log('Write success! Document ID: ' + docRef.id, 'success');
                
                // Clean up
                await docRef.delete();
                log('Cleanup: Test document deleted', 'info');
            } catch (error) {
                log('Write failed: ' + error.message, 'error');
                if (error.message.includes('permission')) {
                    log('ต้องอัพเดท Security Rules ก่อน!', 'warning');
                }
            }
        }
        
        // Test Firestore Read
        async function testFirestoreRead() {
            log('Testing Firestore read (checkins collection)...', 'info');
            try {
                const snapshot = await db.collection('checkins').limit(5).get();
                log(`Read success! Found ${snapshot.size} documents`, 'success');
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    log(`  - ${doc.id}: ${data.customerName || 'N/A'} (Team ${data.team || 'N/A'})`, 'info');
                });
            } catch (error) {
                log('Read failed: ' + error.message, 'error');
            }
        }
        
        // Test Storage Upload
        async function testStorageUpload() {
            log('Testing Storage upload...', 'info');
            try {
                // Create a small test blob
                const testData = 'Hello Firebase Storage! ' + new Date().toISOString();
                const blob = new Blob([testData], { type: 'text/plain' });
                
                const storageRef = storage.ref('_test/test-' + Date.now() + '.txt');
                await storageRef.put(blob);
                
                const downloadURL = await storageRef.getDownloadURL();
                log('Upload success!', 'success');
                log('Download URL: ' + downloadURL, 'info');
                
                // Clean up
                await storageRef.delete();
                log('Cleanup: Test file deleted', 'info');
            } catch (error) {
                log('Upload failed: ' + error.message, 'error');
            }
        }
        
        // Zone mapping
        const ZONE_BRANCH_MAPPING = {
            "เขต 1": ["พุทธมณฑล", "นครปฐม", "หัวหิน", "พระราม 2"],
            "เขต 2": ["สาทร", "ปทุมวัน", "พระราม 4", "นนทบุรี"],
            "เขต 3": ["ปทุมธานี", "รามอินทรา", "อยุธยา"],
            "เขต 4": ["ลาดพร้าว", "พัฒนาการ", "สุวินทวงศ์", "ประชาชื่น"],
            "เขต 5": ["ปราจีนบุรี", "สมุทรปราการ", "พัทยา", "ระยอง"],
            "เขต 6": ["สุขุมวิท", "ปากน้ำ", "ชลบุรี"],
            "เขต 7": ["ปากช่อง", "สระบุรี"],
        };
        
        function getZoneFromBranch(branch) {
            for (const [zone, branches] of Object.entries(ZONE_BRANCH_MAPPING)) {
                if (branches.includes(branch)) return zone;
            }
            return null;
        }
        
        // Create Test Check-in
        async function testCreateCheckin() {
            const customerName = document.getElementById('testCustomerName').value;
            const contractNumber = document.getElementById('testContractNumber').value;
            const team = document.getElementById('testTeam').value;
            const branch = document.getElementById('testBranch').value;
            const zone = getZoneFromBranch(branch);
            
            log('Creating test check-in...', 'info');
            log(`  Customer: ${customerName}`, 'info');
            log(`  Contract: ${contractNumber}`, 'info');
            log(`  Team: ${team}`, 'info');
            log(`  Branch: ${branch} (${zone})`, 'info');
            
            try {
                const checkinData = {
                    team: team,
                    customerName: customerName,
                    contractNumber: contractNumber,
                    branch: branch,
                    zone: zone,
                    location: {
                        lat: 13.7400 + (Math.random() * 0.1 - 0.05),
                        lng: 100.5400 + (Math.random() * 0.1 - 0.05),
                        address: 'ที่อยู่ทดสอบ กรุงเทพฯ',
                        accuracy: 10
                    },
                    photos: {
                        houseFront: null,
                        contractPhoto: null
                    },
                    notes: 'สร้างจาก Test Page',
                    visible: true,
                    checkinTime: firebase.firestore.Timestamp.fromDate(new Date()),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('checkins').add(checkinData);
                log('Check-in created successfully!', 'success');
                log('Document ID: ' + docRef.id, 'success');
                
                // Reload table
                await loadLatestCheckins();
            } catch (error) {
                log('Create failed: ' + error.message, 'error');
            }
        }
        
        // Load Latest Check-ins
        async function loadLatestCheckins() {
            log('Loading latest check-ins...', 'info');
            const tableEl = document.getElementById('checkinsTable');
            
            try {
                const snapshot = await db.collection('checkins')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    tableEl.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">ยังไม่มีข้อมูล Check-in</p>';
                    log('No check-ins found', 'warning');
                    return;
                }
                
                let html = `
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ทีม</th>
                                <th>ลูกค้า</th>
                                <th>สาขา</th>
                                <th>เวลา</th>
                                <th>สถานะ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const time = data.checkinTime?.toDate?.() || data.createdAt?.toDate?.() || new Date();
                    const timeStr = time.toLocaleDateString('th-TH') + ' ' + time.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                    
                    html += `
                        <tr>
                            <td style="font-family: monospace; font-size: 0.8rem;">${doc.id.substring(0, 8)}...</td>
                            <td><span class="badge badge-success">Team ${data.team || '-'}</span></td>
                            <td>${data.customerName || '-'}</td>
                            <td>${data.branch || '-'} (${data.zone || '-'})</td>
                            <td style="font-size: 0.85rem; color: #64748b;">${timeStr}</td>
                            <td><span class="badge ${data.visible ? 'badge-success' : 'badge-error'}">${data.visible ? 'แสดง' : 'ซ่อน'}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                tableEl.innerHTML = html;
                log(`Loaded ${snapshot.size} check-ins`, 'success');
            } catch (error) {
                log('Load failed: ' + error.message, 'error');
                tableEl.innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }
        
        // Run on load
        testConnection();
    </script>
</body>
</html>
